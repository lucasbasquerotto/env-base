name: "{{ params.name }}"
main: 
  custom: "{{ params.env_params.main[params.env_params.ctx] | default({}) }}"
  all_local:
    clouds:
    - "local"
    nodes:
    - "efk_local"
    - "wp_local"
    - "wp_app"
    - "wp_efk_app"
    - "wp_db"
    - "wp_web"
    local:
      pods:
      - "efk"
      - "wp_app_local_dynamic"
      - "wp_app"
      - "wp_app_dynamic"
      - "wp_db"
      - "wp_db_dynamic"
      - "wp_web"
      - "wp_web_dynamic"
      apps:
      - "wp_local"
    run_stages:
      - tasks:
        - name: "docker_compose_install"
          nodes: ["efk_local", "wp_app"]
          nodes_tasks: true
        - name: "docker_compose_install"
          nodes: ["wp_app", "wp_db"]
          pods_tasks: true
        - name: "docker_compose_install"
          nodes: ["wp_web"]
          pods_tasks: true  
      - tasks:
        - name: "docker_compose_install"
          nodes: ["efk_local", "wp_app"]
          nodes_tasks: true
        - name: "docker_compose_install"
          all_nodes: true
          pods_tasks: true
        - name: "docker_compose_install"
          nodes: ["wp_web"]
          pods_tasks: true  
      - tasks:
        - name: "docker_compose_install"
          nodes: ["efk_local", "wp_app"]
          nodes_tasks: true
        - name: "docker_compose_install"
          nodes: ["wp_web"]
          pods_tasks: true  
    shared_params: ["local"]
  wp_local:
    clouds:
    - "local"
    nodes:
    - name: "wp" 
      key: "wp_local"
    local:
      pods:
      - >- 
        {{ 
        params.env_params.dynamic | default(false) | bool | 
        ternary('wp_app_local_dynamic', 'wp_app')
        }}
      apps:
      - "wp_local"
    shared_params: ["local"]
  dns_test:
    destroy: 
      dns: true
    dns: "{{ params.env_params.dns_test | default([]) }}"
    shared_params: ["remote"]
  bind_local:
    clouds:
    - "local"
    nodes:
    - "bind_local"
    local:
      pods:
      - "bind"
    shared_params: ["local"]
  bind: 
    destroy: 
      nodes: true
      buckets: true
    clouds:
    - "{{ params.env_params.cloud_name }}"
    # dns:
    # - name: "{{ params.env_params.dns_name | default('') }}"
    #   dns_type: "NS"
    #   record: "dev"
    #   data_list: 
    #   - value: "ns1dev.{{ params.env_params.domain | default('') }}"      
    #   - value: "ns2dev.{{ params.env_params.domain | default('') }}"
    nodes:
    - name: "bind"
      dependencies:
      - host: "master"
        node: "bind"
        public: true
      - host: "slave"
        node: "bind_slave"
        public: true
    - name: "bind_slave"
      dependencies:
      - host: "master"
        node: "bind"
        public: true
      - host: "slave"
        node: "bind_slave"
        public: true
    run_stages:
    - "nodes"
    - "build"
    - "bind_upgrade"
    - "bind_slave_upgrade"
    shared_params: ["remote"]
  efk_local:
    clouds:
    - "local"
    nodes:
    - "efk_local"
    local:
      pods:
      - >- 
        {{ 
        params.env_params.dynamic | default(false) | bool | 
        ternary('efk_dynamic', 'efk')
        }}
    shared_params: ["local"]
  efk: 
    destroy: 
      nodes: true
      buckets: true
    clouds:
    - "{{ params.env_params.cloud_name }}"
    nodes:
    - "efk"
    run_stages:
    - "default"
    shared_params: ["remote"]
  discourse_local: 
    clouds:
    - "local"
    nodes:
    - "discourse_local"
    local:
      pods:
      - "discourse"
    shared_params: ["local"]
  discourse: 
    destroy: 
      nodes: true
      buckets: true
    clouds:
    - "{{ params.env_params.cloud_name }}"
    dns: "{{ params.env_params.discourse_dns | default([]) }}"
    buckets:
    - "discourse_uploads"
    - "discourse_backup"
    nodes:
    - name: "app"
      key: "discourse_app"
    run_stages:
    - "default"
    shared_params: ["remote"]
  discourse_backup: 
    destroy: 
      nodes: true
      buckets: true
    clouds:
    - "{{ params.env_params.cloud_name }}"
    dns: "{{ params.env_params.discourse_dns | default([]) }}"
    buckets:
    - "discourse_uploads"
    - "discourse_backup"
    nodes:
    - "discourse_app_backup"
    run_stages:
    - tasks:
      - name: "docker_compose_install"
        all_nodes: true
        nodes_tasks: true
      - name: "main_build"
        all_nodes: true
        pods_tasks: true
      - name: "main_upgrade"
        all_nodes: true
        pods_tasks: true
      - name: "discourse_setup"
        all_nodes: true
        pods_tasks: true
      - name: "discourse_rebuild"
        all_nodes: true
        pods_tasks: true
      - name: "discourse_restore"
        all_nodes: true
        pods_tasks: true
    shared_params: ["remote"]
  discourse_multicontainer:
    destroy: 
      nodes: true
      buckets: true
    clouds:
    - "{{ params.env_params.cloud_name }}"
    dns: "{{ params.env_params.discourse_dns | default([]) }}"
    buckets:
    - "discourse_uploads"
    - "discourse_backup"
    nodes:
    - "discourse_multicontainer"
    run_stages:
    - tasks:
      - name: "discourse_setup"
        all_nodes: true
        pods_tasks: true
      - name: "discourse_rebuild_db"
        all_nodes: true
        pods_tasks: true
      - name: "discourse_rebuild_redis"
        all_nodes: true
        pods_tasks: true
      - name: "discourse_rebuild_web"
        all_nodes: true
        pods_tasks: true
    shared_params: ["remote"]
  discourse_nodes: 
    destroy: 
      nodes: true
      buckets: true
    clouds:
    - "{{ params.env_params.cloud_name }}"
    dns: "{{ params.env_params.discourse_dns | default([]) }}"
    buckets:
    - "discourse_uploads"
    - "discourse_backup"
    nodes:
    - name: "db"
      key: "discourse_db"
    - name: "redis"
      key: "discourse_redis"
    - name: "web"
      key: "discourse_web"
      dependencies:
      - host: "redis"
        node: "redis"
      - host: "db"
        node: "db"
    run_stages:
    - tasks:
      - name: "docker_compose_install"
        nodes: ["web"]
        nodes_tasks: true
      - name: "main_build"
        nodes: ["web"]
        pods_tasks: true
      - name: "main_upgrade"
        nodes: ["web"]
        pods_tasks: true
      - name: "discourse_setup"
        all_nodes: true
        pods_tasks: true
    - tasks:
      - name: "discourse_rebuild"
        nodes: ["db", "redis"]
        pods_tasks: true
    - tasks:
      - name: "discourse_wait_db"
        nodes: ["web"]
        pods_tasks: true
      - name: "main_stop"
        nodes: ["web"]
        pods_tasks: true
      - name: "discourse_rebuild"
        nodes: ["web"]
        pods_tasks: true
    shared_params: ["remote"]
  discourse_bootstrap:
    destroy: 
      nodes: true
      buckets: true
    clouds:
    - "{{ params.env_params.cloud_name }}"
    dns: "{{ params.env_params.discourse_dns | default([]) }}"
    nodes:
    - name: "app" 
      key: "discourse_bootstrap"
      tmp: true
    run_stages:
    - tasks:
      - name: "docker_compose_install"
        all_nodes: true
        nodes_tasks: true
      - name: "discourse_setup"
        all_nodes: true
        pods_tasks: true
      - name: "main_upgrade"
        all_nodes: true
        pods_tasks: true
      - name: "discourse_bootstrap_web"
        all_nodes: true
        pods_tasks: true
    shared_params: ["remote"]
  wp: 
    destroy: 
      nodes: true
      buckets: true
    clouds:
    - "{{ params.env_params.cloud_name }}"
    buckets:
    - "wp_uploads"
    - "wp_backup"
    nodes:
    - name: "app" 
      key: "wp_app"
    run_stages:
    - tasks:
      - name: "docker_compose_install"
        all_nodes: true
        nodes_tasks: true
      - name: "main_build"
        all_nodes: true
        pods_tasks: true
      - name: "main_upgrade"
        all_nodes: true
        pods_tasks: true    
    shared_params: ["remote"]   
  wp_efk: 
    destroy: 
      nodes: true
      buckets: true
    clouds:
    - "{{ params.env_params.cloud_name }}"
    buckets:
    - "wp_uploads"
    - "wp_backup"
    nodes:
    - "wp_efk_app"
    run_stages:
    - "nodes"
    - "build"
    - "wp_efk_app_efk"
    - "wp_efk_app_wp"
    - tasks:
      - name: "docker_compose_install"
        all_nodes: true
        nodes_tasks: true
      - name: "main_build"
        all_nodes: true
        pods_tasks: true
      - name: "main_upgrade"
        all_nodes: true
        pods_tasks: true
        partial_pods: true
        pods_per_node:
          wp_efk_app:
          - >-
            {{ 
            params.env_params.dynamic | default(false) | bool | 
            ternary('efk_dynamic', 'efk')
            }}
      - name: "main_upgrade"
        all_nodes: true
        pods_tasks: true
        partial_pods: true
        pods_per_node:
          wp_efk_app:
          - >- 
            {{ 
            params.env_params.dynamic | default(false) | bool | 
            ternary('wp_app_dynamic', 'wp_app')
            }}
    shared_params: ["remote"]
  wp_efk_nodes_local: 
    clouds:
    - "local"
    nodes:
    - name: "efk"
      key: "efk_external"
    run_stages:
    - "nodes"
    - "build"
    - "efk_external_upgrade"
    - "wp_web_stop"
    - "wp_db_upgrade"
    - "wp_web_upgrade"
    shared_params: ["local"]
  wp_efk_nodes: 
    destroy: 
      nodes: true
      buckets: true
    clouds:
    - "{{ params.env_params.cloud_name }}"
    buckets:
    - "wp_uploads"
    - "wp_backup"
    nodes:
    - name: "efk"
      key: "efk_external"
    - name: "wp_db"
      dependencies:
      - host: "elasticsearch"
        node: "efk"
    - name: "wp_web"
      dependencies:
      - host: "elasticsearch"
        node: "efk"
      - host: "mysql"
        node: "wp_db"
    run_stages:
    - "nodes"
    - "build"
    - "efk_external_upgrade"
    - "wp_web_stop"
    - "wp_db_upgrade"
    - "wp_web_upgrade"
    shared_params: ["remote"]
  wp_remote_test_setup_remote_backup_sync:
    hooks: "test"
    destroy: 
      nodes: true
      buckets: true
    clouds:
    - "{{ params.env_params.cloud_name }}"
    nodes:
    - "wp_remote_test_setup_remote_backup_sync"
    run_stages:
    - "default"
    - "backup"
    group_params:
      env_repos: "test_env_repos"
    shared_params: ["remote"]
  wp_remote_test_setup_bucket_dir_backup_no_sync:
    hooks: "test"
    destroy: 
      nodes: true
      buckets: true
    clouds:
    - "{{ params.env_params.cloud_name }}"
    nodes:
    - "wp_remote_test_setup_bucket_dir_backup_no_sync"
    run_stages:
    - "default"
    - "backup"
    group_params:
      env_repos: "test_env_repos"
    shared_params: ["remote"]
  wp_remote_test_setup_bucket_file_backup_sync:
    hooks: "test"
    destroy: 
      nodes: true
      buckets: true
    clouds:
    - "{{ params.env_params.cloud_name }}"
    nodes:
    - "wp_remote_test_setup_bucket_file_backup_sync"
    run_stages:
    - "default"
    - "backup"
    - "wait"
    - "clear"
    group_params:
      env_repos: "test_env_repos"
    shared_params: ["remote"]
  wp_local_test_setup_remote_backup_sync:
    hooks: "test"
    clouds:
    - "local"
    nodes:
    - "wp_local_test_setup_remote_backup_sync"
    local:
      pods:
      - "wp_app_local_dynamic"
      apps:
      - "wp_local"
    group_params:
      env_repos: "test_env_repos"
    shared_params: ["local"]
  wp_local_test_setup_bucket_dir_backup_no_sync:
    hooks: "test"
    clouds:
    - "local"
    nodes:
    - "wp_local_test_setup_bucket_dir_backup_no_sync"
    local:
      pods:
      - "wp_app_local_dynamic"
      apps:
      - "wp_local"
    group_params:
      env_repos: "test_env_repos"
    shared_params: ["local"]
  wp_local_test_setup_bucket_file_backup_sync:
    hooks: "test"
    clouds:
    - "local"
    nodes:
    - "wp_local_test_setup_bucket_file_backup_sync"
    local:
      pods:
      - "wp_app_local_dynamic"
      apps:
      - "wp_local"
    group_params:
      env_repos: "test_env_repos"
    shared_params: ["local"]
main_shared_params:
  local:
    entrypoint: "main.yml"
    entrypoint_template_src: "main.tpl.yml"
    hosts_content: |
      [main]
      localhost ansible_connection=local
      [host]
    meta:
      template_no_empty_lines: true
    repo: "cloud"
  remote:
    entrypoint: "main.yml"
    entrypoint_template_src: "main.tpl.yml"
    hosts_file: "{{ params.env.repo_dir }}/hosts/dev.hosts"
    meta:
      template_no_empty_lines: false
    repo: "cloud"
main_params:
  test_env_repos: 
  - repo: "custom_cloud"
    dir: "custom-cloud"
hooks:
  test:
    before_cloud_main: "custom-cloud/hooks/before_cloud_main.yml"
    after_cloud_main: "custom-cloud/hooks/after_cloud_main.yml"
    before_dns: "custom-cloud/hooks/before_dns.yml"
    after_dns: "custom-cloud/hooks/after_dns.yml"
    before_buckets: "custom-cloud/hooks/before_buckets.yml"
    after_buckets: "custom-cloud/hooks/after_buckets.yml"
    before_nodes: "custom-cloud/hooks/before_nodes.yml"
    after_nodes: "custom-cloud/hooks/after_nodes.yml"
    before_wait_nodes: "custom-cloud/hooks/before_wait_nodes.yml"
    after_wait_nodes: "custom-cloud/hooks/after_wait_nodes.yml"
    before_local_prepare: "custom-cloud/hooks/before_local_prepare.yml"
    after_local_prepare: "custom-cloud/hooks/after_local_prepare.yml"
    before_remote_prepare: "custom-cloud/hooks/before_remote_prepare.yml"
    after_remote_prepare: "custom-cloud/hooks/after_remote_prepare.yml"
    before_cron: "custom-cloud/hooks/before_cron.yml"
    after_cron: "custom-cloud/hooks/after_cron.yml"
    before_exec: "custom-cloud/hooks/before_exec.yml"
    after_exec: "custom-cloud/hooks/after_exec.yml"
    before_delete_tmp: "custom-cloud/hooks/before_delete_tmp.yml"
    after_delete_tmp: "custom-cloud/hooks/after_delete_tmp.yml"
    before_delete_main: "custom-cloud/hooks/before_delete_main.yml"
    after_delete_main: "custom-cloud/hooks/after_delete_main.yml"
clouds:
  local:
    type: "local"
  do:
    type: "digital_ocean"
    credentials: "digital_ocean"
    params:
      meta:
        use_dict: true
      x_digital_ocean_tags:
      - "auto"
      - "dns"
      - "dmz"
      - "mysql"
      - "kibana"
      - "redis"
      - "postgres"
      x_digital_ocean_firewalls:
      - "auto"
      - "dns"
      - "dmz"
      - "mysql"
      - "kibana"
      - "redis"
      - "postgres"
    shared_group_params: "digital_ocean"
cloud_shared_group_params: 
  digital_ocean:  
    x_digital_ocean_firewalls_dict: "do_firewalls_dict"
cloud_params:   
  do_firewalls_dict:
    auto:
      name: "auto"
      tags: ["auto"]
      inbound_rules:
      - ports: "22"
        sources:
          tags: ["main"]
      outbound_rules:
      - protocol: "tcp"
        ports: "1-65535"
        destinations:
          addresses: ["0.0.0.0/0", "::/0"]
      - protocol: "udp"
        ports: "1-65535"
        destinations:
          addresses: ["0.0.0.0/0", "::/0"]
      - protocol: "icmp"
        ports: "1-65535"
        destinations:
          addresses: ["0.0.0.0/0", "::/0"]
    dns:
      name: "dns"
      tags: ["dns"]
      inbound_rules:
      - ports: "53"
        sources:
          addresses: ["0.0.0.0/0", "::/0"]
    dmz:
      name: "dmz"
      tags: ["dmz"]
      inbound_rules:
      - ports: "80"
        sources:
          addresses: ["0.0.0.0/0", "::/0"]
      - ports: "443"
        sources:
          addresses: ["0.0.0.0/0", "::/0"]
    mysql:
      name: "mysql"
      tags: ["mysql"]
      inbound_rules:
      - ports: "3306"
        sources:
          tags: ["web"]
    kibana:
      name: "kibana"
      tags: ["kibana"]
      inbound_rules:
      - ports: "5601"
        sources:
          addresses: ["0.0.0.0/0", "::/0"]
    redis:
      name: "redis"
      tags: ["redis"]
      inbound_rules:
      - ports: "6379"
        sources:
          tags: ["web"]
    postgres:
      name: "postgres"
      tags: ["postgres"]
      inbound_rules:
      - ports: "5432"
        sources:
          tags: ["web"]
dns:
  nsupdate: 
    type: "nsupdate"
    zone: "{{ params.env_params.nsupdate_domain | default('') }}"
    credentials: "nsupdate"
  cloudflare: 
    type: "cloudflare"
    zone: "{{ params.env_params.domain }}"
    credentials: "cloudflare"
  godaddy: 
    type: "godaddy"
    zone: "{{ params.env_params.domain }}"
    credentials: "godaddy"
buckets: 
  wp_backup:
    name: "{{ params.env_params.wp_backup_bucket.name | default('') }}"
    endpoint: "{{ params.env_params.wp_backup_bucket.endpoint | default('') }}"
    credentials: "{{ params.env_params.wp_backup_bucket.credentials | default('') }}"
  wp_uploads:
    name: "{{ params.env_params.wp_uploads_bucket.name | default('') }}"
    endpoint: "{{ params.env_params.wp_uploads_bucket.endpoint | default('') }}"
    credentials: "{{ params.env_params.wp_uploads_bucket.credentials | default('') }}"
  discourse_uploads:
    name: "{{ params.env_params.discourse_uploads_bucket.name | default('') }}"
    endpoint: "{{ params.env_params.discourse_uploads_bucket.endpoint | default('') }}"
    credentials: "{{ params.env_params.discourse_uploads_bucket.credentials | default('') }}"
  discourse_backup:
    name: "{{ params.env_params.discourse_backup_bucket.name | default('') }}"
    endpoint: "{{ params.env_params.discourse_backup_bucket.endpoint | default('') }}"
    credentials: "{{ params.env_params.discourse_backup_bucket.credentials | default('') }}"
nodes:
  bind_local:
    cloud: "local"
    base_dir: "/var/cloud"
    credentials: "user"
    pods: 
    - name: "bind"
      params:
        bind_type: "master"
    tasks_group: "node_prepare"
    shared_params: ["local_small"]
  bind:
    cloud: "{{ params.env_params.cloud_name }}"
    base_dir: "/var/cloud"
    credentials: "{{ params.env_params.local | default(false) | bool | ternary('user', 'host') }}"
    pods:
    - name: "bind"
      params:
        bind_type: "master"
    tasks_group: "node_prepare"
    params: 
      dns:
      - "ns1dev"
      x_digital_ocean_tags:
      - "auto"
      - "dns"
    shared_params:
    - "default_micro"
    shared_group_params: "main"
  bind_slave:
    cloud: "{{ params.env_params.cloud_name }}"
    base_dir: "/var/cloud"
    credentials: "{{ params.env_params.local | default(false) | bool | ternary('user', 'host') }}"
    pods:
    - name: "bind"
      params:
        bind_type: "slave"
    tasks_group: "node_prepare"
    params: 
      dns:
      - "ns2dev"
      x_digital_ocean_tags:
      - "auto"
      - "dns"
    shared_params:
    - "default_micro"
    shared_group_params: "main"
  efk_local:
    cloud: "local"
    base_dir: "/var/cloud"
    credentials: "user"
    pods: 
    - name: "efk"
      key: >- 
        {{ 
        params.env_params.dynamic | default(false) | bool | 
        ternary('efk_dynamic', 'efk')
        }}
      main: true
    tasks_group: "node_prepare"
    shared_params: ["local_small"]
  efk:
    cloud: "{{ params.env_params.cloud_name }}"
    base_dir: "/var/cloud"
    credentials: "{{ params.env_params.local | default(false) | bool | ternary('user', 'host') }}"
    pods: 
    - name: "efk"
      key: >- 
        {{ 
        params.env_params.dynamic | default(false) | bool | 
        ternary('efk_dynamic', 'efk')
        }}
      main: true
    tasks_group: "node_prepare"
    params: 
      dns:
      - "log"
      x_digital_ocean_tags:
      - "auto"
      - "kibana"
    shared_params:
    - "default_small"
    shared_group_params: "main"
  efk_external:
    cloud: "{{ params.env_params.cloud_name }}"
    base_dir: "/var/cloud"
    credentials: "{{ params.env_params.local | default(false) | bool | ternary('user', 'host') }}"
    pods: 
    - name: "efk"
      key: >- 
        {{ 
        params.env_params.dynamic | default(false) | bool | 
        ternary('efk_external_dynamic', 'efk_external')
        }}
      main: true
    tasks_group: "node_prepare"
    params: 
      dns:
      - "log"
      x_digital_ocean_tags:
      - "auto"
      - "kibana"
    shared_params:
    - "default_small"
    shared_group_params: "main"
  wp_local:
    cloud: "local"
    base_dir: "/var/cloud"
    credentials: "user"
    pods: 
    - name: "wp"
      key: >- 
        {{ 
        params.env_params.dynamic | default(false) | bool | 
        ternary('wp_app_local_dynamic', 'wp_app')
        }}
      main: true
    tasks_group: "node_prepare"
    shared_params: ["local_small"]
  wp_local_test_setup_remote_backup_sync:
    cloud: "local"
    base_dir: "/var/cloud"
    credentials: "user"
    pods:
    - name: "wp_app_local_dynamic"
      group_params:
        run: "wp_run_setup_remote_backup_sync"
    tasks_group: "node_prepare"
    params: 
      size: "{{ params.env_params.node_size | default('micro') }}"
      cron: 
      - "local"
    shared_group_params: "main"
  wp_local_test_setup_bucket_dir_backup_no_sync:
    cloud: "local"
    base_dir: "/var/cloud"
    credentials: "user"
    pods:
    - name: "wp_app_local_dynamic"
      group_params:
        run: "wp_run_setup_bucket_dir_backup_no_sync"
    tasks_group: "node_prepare"
    params: 
      size: "{{ params.env_params.node_size | default('micro') }}"
      cron: 
      - "local"
    shared_group_params: "main"
  wp_local_test_setup_bucket_file_backup_sync:
    cloud: "local"
    base_dir: "/var/cloud"
    credentials: "user"
    pods:
    - name: "wp_app_local_dynamic"
      group_params:
        run: "wp_run_setup_bucket_file_backup_sync"
    tasks_group: "node_prepare"
    params: 
      size: "{{ params.env_params.node_size | default('micro') }}"
      cron: 
      - "local"
    shared_group_params: "main"
  wp_remote_test_setup_remote_backup_sync:
    cloud: "{{ params.env_params.cloud_name }}"
    base_dir: "/var/cloud"
    credentials: "host"
    pods:
    - name: "wp_app_dynamic"
      group_params:
        run: "wp_run_setup_remote_backup_sync"
    tasks_group: "node_prepare"
    params: 
      dns:
      - "blog"
      x_digital_ocean_tags:
      - "auto"
      - "dmz"
    shared_params:
    - "default_micro"
    shared_group_params: "main"
  wp_remote_test_setup_bucket_dir_backup_no_sync:
    cloud: "{{ params.env_params.cloud_name }}"
    base_dir: "/var/cloud"
    credentials: "host"
    pods:
    - name: "wp_app_dynamic"
      group_params:
        run: "wp_run_setup_bucket_dir_backup_no_sync"
    tasks_group: "node_prepare"
    params: 
      dns:
      - "blog"
      x_digital_ocean_tags:
      - "auto"
      - "dmz"
    shared_params:
    - "default_micro"
    shared_group_params: "main"
  wp_remote_test_setup_bucket_file_backup_sync:
    cloud: "{{ params.env_params.cloud_name }}"
    base_dir: "/var/cloud"
    credentials: "host"
    pods:
    - name: "wp_app_dynamic"
      group_params:
        run: "wp_run_setup_bucket_file_backup_sync"
    tasks_group: "node_prepare"
    params: 
      dns:
      - "blog"
      x_digital_ocean_tags:
      - "auto"
      - "dmz"
    shared_params:
    - "default_micro"
    shared_group_params: "main"
  discourse_local:
    cloud: "local"
    base_dir: "/var/cloud"
    credentials: "user"
    pods:
    - name: "discourse"
      group_params:
        containers: >- 
          {{ 
          params.env_params.dynamic | default(false) | bool | 
          ternary('discourse_containers_app', 'discourse_containers_app_static')
          }}
        run: "discourse_run"
    tasks_group: "node_prepare"
    shared_params: ["local_small"]
  discourse_app:
    cloud: "{{ params.env_params.cloud_name }}"
    base_dir: "/var/cloud"
    credentials: "{{ params.env_params.node_credentials }}"
    pods:
    - name: "discourse"
      group_params:
        containers: >- 
          {{ 
          params.env_params.dynamic | default(false) | bool | 
          ternary('discourse_containers_app', 'discourse_containers_app_static')
          }}
    tasks_group: "node_prepare"
    params: 
      dns:
      - "forum"
      x_digital_ocean_tags:
      - "auto"
      - "dmz"
    shared_params:
    - "default_micro"
    shared_group_params: "main"
  discourse_app_backup:
    cloud: "{{ params.env_params.cloud_name }}"
    base_dir: "/var/cloud"
    credentials: "{{ params.env_params.node_credentials }}"
    pods:
    - name: "discourse"
      group_params:
        containers: >- 
          {{ 
          params.env_params.dynamic | default(false) | bool | 
          ternary('discourse_containers_app', 'discourse_containers_app_static')
          }}
        run: "discourse_run"
    tasks_group: "node_prepare"
    params: 
      dns:
      - "forum"
      x_digital_ocean_tags:
      - "auto"
      - "dmz"
    shared_params:
    - "default_micro"
    shared_group_params: "main"
  discourse_web:
    cloud: "{{ params.env_params.cloud_name }}"
    base_dir: "/var/cloud"
    credentials: "{{ params.env_params.node_credentials }}"
    pods:
    - name: "discourse"
      group_params:
        containers: >- 
          {{ 
          params.env_params.dynamic | default(false) | bool | 
          ternary('discourse_containers_web', 'discourse_containers_web_static')
          }}
        run: "discourse_run"
    tasks_group: "node_prepare"
    params: 
      dns:
      - "forum"
      x_digital_ocean_tags:
      - "auto"
      - "web"
      - "dmz"
    shared_params:
    - "default_small"
    shared_group_params: "main"
  discourse_redis:
    cloud: "{{ params.env_params.cloud_name }}"
    base_dir: "/var/cloud"
    credentials: "{{ params.env_params.node_credentials }}"
    pods:
    - name: "discourse"
      group_params:
        containers: "discourse_containers_redis"
    tasks_group: "node_prepare"
    params: 
      x_digital_ocean_tags:
      - "auto"
      - "redis"
    shared_params:
    - "default_small"
    shared_group_params: "main"
  discourse_db:
    cloud: "{{ params.env_params.cloud_name }}"
    base_dir: "/var/cloud"
    credentials: "{{ params.env_params.node_credentials }}"
    pods:
    - name: "discourse"
      group_params:
        containers: "discourse_containers_db"
    tasks_group: "node_prepare"
    params: 
      x_digital_ocean_tags:
      - "auto"
      - "postgres"
    shared_params:
    - "default_small"
    shared_group_params: "main"
  discourse_multicontainer:
    cloud: "{{ params.env_params.cloud_name }}"
    base_dir: "/var/cloud"
    credentials: "{{ params.env_params.node_credentials }}"
    pods:
    - name: "discourse"
      group_params:
        containers: "discourse_containers_multicontainer"
    tasks_group: "node_prepare"
    params: 
      dns:
      - "forum"
      x_digital_ocean_tags:
      - "auto"
      - "web"
      - "dmz"
    shared_params:
    - "default_micro"
    shared_group_params: "main"
  discourse_bootstrap:
    cloud: "{{ params.env_params.cloud_name }}"
    base_dir: "/var/cloud"
    credentials: "{{ params.env_params.node_credentials }}"
    pods:
    - name: "discourse"
      group_params:
        containers: "discourse_containers_bootstrap"
        run: "discourse_run_bootstrap"
    tasks_group: "node_prepare"
    params: 
      static: true
      x_digital_ocean_tags:
      - "auto"
    shared_params:
    - "default_micro"
    shared_group_params: "main"
  wp_app:
    cloud: "{{ params.env_params.cloud_name }}"
    base_dir: "/var/cloud"
    credentials: "{{ params.env_params.node_credentials }}"
    pods: 
    - name: "wp"
      key: >- 
        {{ 
        params.env_params.dynamic | default(false) | bool | 
        ternary('wp_app_dynamic', 'wp_app')
        }}
      main: true
    tasks_group: "node_prepare"
    params: 
      cron: 
      - "app"
      dns:
      - "blog"
      x_digital_ocean_tags:
      - "auto"
      - "dmz"
    shared_params:
    - "default_micro"
    shared_group_params: "main"
  wp_efk_app:
    cloud: "{{ params.env_params.cloud_name }}"
    base_dir: "/var/cloud"
    credentials: "{{ params.env_params.node_credentials }}"
    pods: 
    - name: "efk"
      key: >- 
        {{ 
        params.env_params.dynamic | default(false) | bool | 
        ternary('efk_dynamic', 'efk')
        }}
      shared_group_params: "wp_efk_app_pods"
    - name: "wp"
      key: >- 
        {{ 
        params.env_params.dynamic | default(false) | bool | 
        ternary('wp_app_dynamic', 'wp_app')
        }}
      main: true
      params:
        default_logging: >- 
          {{ 
          params.env_params.dynamic | default(false) | bool | 
          ternary('wp_efk', '')
          }}
      shared_group_params: >- 
        {{ 
        params.env_params.dynamic | default(false) | bool | 
        ternary('wp_efk_app_pods', '')
        }}
    tasks_group: "node_prepare"
    params: 
      cron: 
      - "app"
      dns:
      - "blog"
      x_digital_ocean_tags:
      - "auto"
      - "dmz"
      - "kibana"
    shared_params:
    - "default_medium"
    shared_group_params: "main"
  wp_db:
    cloud: "{{ params.env_params.cloud_name }}"
    base_dir: "/var/cloud"
    credentials: "{{ params.env_params.node_credentials }}"
    pods: 
    - name: "wp"
      key: >- 
        {{ 
        params.env_params.dynamic | default(false) | bool | 
        ternary('wp_db_dynamic', 'wp_db')
        }}
      main: true
    tasks_group: "node_prepare"
    params: 
      cron: 
      - "app"
      x_digital_ocean_tags:
      - "auto"
      - "mysql"
    shared_params:
    - "default_micro"
    shared_group_params: "main"
  wp_web:
    cloud: "{{ params.env_params.cloud_name }}"
    base_dir: "/var/cloud"
    credentials: "{{ params.env_params.node_credentials }}"
    pods: 
    - name: "wp"
      key: >- 
        {{ 
        params.env_params.dynamic | default(false) | bool | 
        ternary('wp_web_dynamic', 'wp_web')
        }}
      main: true
    tasks_group: "node_prepare"
    params: 
      cron: 
      - "app"
      dns:
      - "blog"
      x_digital_ocean_tags:
      - "auto"
      - "dmz"
      - "web"
    shared_params:
    - "default_micro"
    shared_group_params: "main"
node_shared_params:
  local_small:
    size:
      memory: "2gb"
      cpu: 2
    cron:
    - user: "root"
      src_file: "{{ params.env.repo_dir }}/cron/test.cron"
      dest_dir: "/var/spool/cron/crontabs"
  default_micro:
    meta:
      use_dict: true
    instance: "ubuntu"
    region: "default"
    size: "micro"
    host_test: "default"
  default_small:
    meta:
      use_dict: true
    instance: "ubuntu"
    region: "default"
    size: "small"
    host_test: "default"
  default_medium:
    meta:
      use_dict: true
    instance: "ubuntu"
    region: "default"
    size: "medium"
    host_test: "default"
node_shared_group_params:
  main:
    cloud_instance_dict: "main_cloud_instance_dict"
    cloud_region_dict: "main_cloud_region_dict"
    cloud_size_dict: "main_cloud_size_dict"
    host_test_dict: "main_host_test_dict"
    cron_dict: "main_cron_dict"
    dns_dict: "main_dns_dict"
node_params:
  main_cloud_instance_dict:
    digital_ocean:
      ubuntu:
        image: "ubuntu-18-04-x64"
        user_data_file: "{{ params.env.repo_dir }}/templates/ubuntu-18.04.j2.sh"
        ipv6: "yes"
  main_cloud_region_dict:
    digital_ocean:
      default:
        name: "nyc3"
  main_cloud_size_dict:
    digital_ocean:
      micro:
        name: "s-1vcpu-1gb"
        memory: "1gb"
        cpu: 1
      small:
        name: "s-2vcpu-2gb"
        memory: "2gb"
        cpu: 2
      medium:
        name: "s-2vcpu-4gb"
        memory: "4gb"
        cpu: 2
    local:
      micro:
        memory: "1gb"
        cpu: 1
      small:
        memory: "2gb"
        cpu: 2
      medium:
        memory: "4gb"
        cpu: 4
      large:
        memory: "8gb"
        cpu: 8
      xlarge:
        memory: "16gb"
        cpu: 16
      x2large:
        memory: "32gb"
        cpu: 32
      x4large:
        memory: "64gb"
        cpu: 64
  main_host_test_dict:
    default:
      log_file: "/var/log/setup.log"
      setup_last_line: "Setup Finished"
      initial_connection_timeout: 90
      setup_finished_timeout: 300
  main_cron_dict: 
    app:
      user: "root"
      src_file: "{{ params.env.repo_dir }}/cron/app.cron"
      dest_dir: "/var/spool/cron/crontabs"
  main_dns_dict: 
    blog:
      name: "{{ params.env_params.dns_name | default('') }}"
      record: "blog"
    forum:
      name: "{{ params.env_params.dns_name | default('') }}"
      record: "forum"
    log:
      name: "{{ params.env_params.dns_name | default('') }}"
      record: "log"
    ns1dev:
      name: "{{ params.env_params.dns_name | default('') }}"
      record: "ns1dev"
    ns2dev:
      name: "{{ params.env_params.dns_name | default('') }}"
      record: "ns2dev"
pods:
  bind:
    repo: "pod"
    root: "yes"
    ctx: "custom-pod/bind/ctx.yml"
    fast_prepare: "true"
    tasks_group: "pod_bind"
    env_repos: 
    - repo: "custom_pod"
      dir: "custom-pod"
    credentials:
      bind: "bind"
      backup_bucket: "{{ params.env_params.backup_bucket.credentials | default('') }}"
    params:
      custom_dir: "custom-pod"
      type: "app"
      local: "{{ params.env_params.local | default(false) }}"
      orchestration: "docker_compose"
    shared_group_params: "bind_custom_app"
  efk:
    repo: "pod"
    root: "yes"
    ctx: "custom-pod/efk/ctx.yml"
    fast_prepare: "true"
    tasks_group: "pod_efk"
    env_repos: 
    - repo: "custom_pod"
      dir: "custom-pod"
    params:
      type: "app"
      local: "{{ params.env_params.local | default(false) }}"
      orchestration: "docker_compose"
      custom_dir: "custom-pod"
    shared_group_params: "efk_custom_app"
  efk_dynamic:
    repo: "pod"
    root: "yes"
    ctx: "main/log/ctx.yml"
    fast_prepare: "true"
    tasks_group: "pod_efk"
    params:
      type: "app"
      local: "{{ params.env_params.local | default(false) }}"
      orchestration: "docker_compose"
      default_logging: "log"
      volumes:
      - "elasticsearch"
      networks:
      - "log"
      services:
      - "fluentd"
      - "elasticsearch"
      - "kibana"
    group_params:
      memory_dict: "efk_memory_dict"
      run: "efk_run_dynamic"
    shared_group_params: "main"
  efk_external:
    repo: "pod"
    root: "yes"
    ctx: "custom-pod/efk/ctx.yml"
    fast_prepare: "true"
    tasks_group: "pod_efk"
    env_repos: 
    - repo: "custom_pod"
      dir: "custom-pod"
    params:
      type: "external"
      local: "{{ params.env_params.local | default(false) }}"
      orchestration: "docker_compose"
      custom_dir: "custom-pod"
    shared_group_params: "efk_custom_external"
  efk_external_dynamic:
    repo: "pod"
    root: "yes"
    ctx: "main/log/ctx.yml"
    fast_prepare: "true"
    tasks_group: "pod_efk"
    params:
      type: "external"
      local: "{{ params.env_params.local | default(false) }}"
      orchestration: "docker_compose"
      default_logging: "log"
      volumes:
      - "elasticsearch"
      networks:
      - "log"
      services:
      - "elasticsearch"
      - "kibana"
    group_params:
      memory_dict: "efk_memory_dict"
      run: "efk_run_dynamic"
    shared_group_params: "main"
  wp_app_local_dynamic:
    repo: "pod"
    root: "yes"
    ctx: "main/wordpress/ctx.yml"
    fast_prepare: "true"
    tasks_group: "pod_wp"
    credentials:
      wordpress: "wordpress"
      mysql: "mysql"
      wp_backup_bucket: "{{ params.env_params.wp_backup_bucket.credentials | default('') }}"
      wp_uploads_bucket: "{{ params.env_params.wp_uploads_bucket.credentials | default('') }}"
    params:
      type: "app"
      local: true
      orchestration: "docker_compose"
      default_logging: "wp_app"
      volumes:
      - "wordpress"
      managed_volumes:
      - "mysql"
      networks:
      - "internet"
      - "local"
      services:
      - "nginx"
      - "wordpress"
      - "phpmyadmin"
      - "mysql"
      - "toolbox"
      - "composer"
      run_services:
      - "wp_s3_uploads"
      - "wp_s3_backup"
      map_src_path_dict:
        wp_s3_backup: "toolbox"
        wp_s3_uploads: "toolbox"
      map_services_dict:
        wp_s3_backup: "toolbox"
        wp_s3_uploads: "toolbox"
      map_services_memory_dict:
        wp_s3_backup: "toolbox"
        wp_s3_uploads: "toolbox"
      map_services_depends_on_dict:
        wordpress: "wordpress_app"
        phpmyadmin: "phpmyadmin_app"
      map_services_networks_dict:
        phpmyadmin: "phpmyadmin_app"
        mysql: "mysql_app"
      map_services_volumes_dict:
        mysql: "mysql_local"
        wordpress: "wordpress_local"
        wp_s3_backup: "toolbox"
        wp_s3_uploads: "toolbox"
    group_params:
      memory_dict: "wp_app_memory_dict"
      meta: "wp_meta"
      run: "wp_run_dynamic_app"
      run_dict: "wp_run_dict"
    shared_group_params: "main"
  wp_app:
    repo: "pod"
    root: "yes"
    ctx: "custom-pod/wordpress/ctx.yml"
    fast_prepare: "true"
    tasks_group: "pod_wp"
    env_repos: 
    - repo: "custom_pod"
      dir: "custom-pod"
    credentials:
      wordpress: "wordpress"
      mysql: "mysql"
      wp_backup_bucket: "{{ params.env_params.wp_backup_bucket.credentials | default('') }}"
      wp_uploads_bucket: "{{ params.env_params.wp_uploads_bucket.credentials | default('') }}"
    params:
      type: "app"
      local: "{{ params.env_params.local | default(false) }}"
      orchestration: "docker_compose"
      custom_dir: "custom-pod"
    shared_group_params: "wp_custom_app"
  wp_app_dynamic:
    repo: "pod"
    root: "yes"
    ctx: "main/wordpress/ctx.yml"
    fast_prepare: "true"
    tasks_group: "pod_wp"
    credentials:
      wordpress: "wordpress"
      mysql: "mysql"
      wp_backup_bucket: "{{ params.env_params.wp_backup_bucket.credentials | default('') }}"
      wp_uploads_bucket: "{{ params.env_params.wp_uploads_bucket.credentials | default('') }}"
    params:
      type: "app"
      local: false
      orchestration: "docker_compose"
      default_logging: "wp_app"
      volumes:
      - "mysql"
      - "wordpress"
      networks:
      - "internet"
      - "local"
      services:
      - "nginx"
      - "wordpress"
      - "phpmyadmin"
      - "mysql"
      - "toolbox"
      run_services:
      - "wp_s3_uploads"
      - "wp_s3_backup"
      map_src_path_dict:
        wp_s3_backup: "toolbox"
        wp_s3_uploads: "toolbox"
      map_services_dict:
        wp_s3_backup: "toolbox"
        wp_s3_uploads: "toolbox"
      map_services_memory_dict:
        wp_s3_backup: "toolbox"
        wp_s3_uploads: "toolbox"
      map_services_depends_on_dict:
        wordpress: "wordpress_app"
        phpmyadmin: "phpmyadmin_app"
      map_services_networks_dict:
        phpmyadmin: "phpmyadmin_app"
        mysql: "mysql_app"
      map_services_volumes_dict:
        wp_s3_backup: "toolbox"
        wp_s3_uploads: "toolbox"
    group_params:
      memory_dict: "wp_app_memory_dict"
      meta: "wp_meta"
      run: "wp_run_dynamic_app"
      run_dict: "wp_run_dict"
    shared_group_params: "main"
  wp_db:
    repo: "pod"
    root: "yes"
    ctx: "custom-pod/wordpress/ctx.yml"
    fast_prepare: "true"
    tasks_group: "pod_wp"
    env_repos: 
    - repo: "custom_pod"
      dir: "custom-pod"
    credentials:
      wordpress: "wordpress"
      mysql: "mysql"
      wp_backup_bucket: "{{ params.env_params.wp_backup_bucket.credentials | default('') }}"
    params:
      type: "db"
      local: "{{ params.env_params.local | default(false) }}"
      orchestration: "docker_compose"
      custom_dir: "custom-pod"
    shared_group_params: "wp_custom_db"
  wp_db_dynamic:
    repo: "pod"
    root: "yes"
    ctx: "main/wordpress/ctx.yml"
    fast_prepare: "true"
    tasks_group: "pod_wp"
    credentials:
      wordpress: "wordpress"
      mysql: "mysql"
      wp_backup_bucket: "{{ params.env_params.wp_backup_bucket.credentials | default('') }}"
    params:
      type: "db"
      local: false
      orchestration: "docker_compose"
      default_logging: "wp_efk"
      volumes:
      - "mysql"
      networks:
      - "internet"
      - "local"
      - "log"
      services:
      - "mysql"
      - "toolbox"
      - "fluentd"
      run_services:
      - "wp_s3_backup"
      map_services_depends_on_dict:
        mysql: "mysql_db"
        toolbox: "toolbox_db"
      map_src_path_dict:
        wp_s3_backup: "toolbox"
      map_services_dict:
        wp_s3_backup: "toolbox"
      map_services_memory_dict:
        wp_s3_backup: "toolbox"
      map_services_ports_dict:
        mysql: "mysql_db"
      map_services_volumes_dict:
        wp_s3_backup: "toolbox"
    group_params:
      memory_dict: "wp_db_memory_dict"
      meta: "wp_meta"
      run: "wp_run_dynamic_db"
      run_dict: "wp_run_dict"
    shared_group_params: "main"
  wp_web:
    repo: "pod"
    root: "yes"
    ctx: "custom-pod/wordpress/ctx.yml"
    fast_prepare: "true"
    tasks_group: "pod_wp"
    env_repos: 
    - repo: "custom_pod"
      dir: "custom-pod"
    credentials:
      wordpress: "wordpress"
      mysql: "mysql"
      wp_uploads_bucket: "{{ params.env_params.wp_uploads_bucket.credentials | default('') }}"
      wp_backup_bucket: "{{ params.env_params.wp_backup_bucket.credentials | default('') }}"
    params:
      type: "web"
      local: "{{ params.env_params.local | default(false) }}"
      orchestration: "docker_compose"
      custom_dir: "custom-pod"
    shared_group_params: "wp_custom_web"
  wp_web_dynamic:
    repo: "pod"
    root: "yes"
    ctx: "main/wordpress/ctx.yml"
    fast_prepare: "true"
    tasks_group: "pod_wp"
    credentials:
      wordpress: "wordpress"
      mysql: "mysql"
      wp_uploads_bucket: "{{ params.env_params.wp_uploads_bucket.credentials | default('') }}"
    params:
      type: "web"
      local: false
      orchestration: "docker_compose"
      default_logging: "wp_efk"
      volumes:
      - "wordpress"
      networks:
      - "internet"
      - "local"
      - "log"
      services:
      - "nginx"
      - "wordpress"
      - "phpmyadmin"
      - "toolbox"
      - "fluentd"
      run_services:
      - "wp_s3_uploads"
      map_services_depends_on_dict:
        nginx: "nginx_web"
        wordpress: "wordpress_web"
        phpmyadmin: "phpmyadmin_web"
        toolbox: "toolbox_web"
      map_src_path_dict:
        wp_s3_uploads: "toolbox"
      map_services_dict:
        wp_s3_uploads: "toolbox"
      map_services_memory_dict:
        wp_s3_uploads: "toolbox"
      map_services_volumes_dict:
        wp_s3_uploads: "toolbox"
    group_params:
      memory_dict: "wp_web_memory_dict"
      meta: "wp_meta"
      run: "wp_run_dynamic_web"
      run_dict: "wp_run_dict"
    shared_group_params: "main"
  discourse:
    repo: "pod"
    root: "yes"
    ctx: "custom-pod/discourse/ctx.yml"
    fast_prepare: "true"
    tasks_group: "pod_discourse"
    env_repos: 
    - repo: "custom_pod"
      dir: "custom-pod"
    - repo: >- 
        {{ 
        params.env_params.dynamic | default(false) | bool | 
        ternary('discourse_docker', 'discourse_docker_static')
        }}
      dir: "repo-discourse"
    credentials:
      discourse_backup_bucket: "{{ params.env_params.discourse_backup_bucket.credentials | default('') }}"
    params: 
      custom_dir: "custom-pod"
      discourse_dir: "repo-discourse"
      local: "{{ params.env_params.local | default(false) }}"
      static: >- 
        {{ 
        params.env_params.dynamic | default(false) | bool | 
        ternary('false', 'true')
        }}
    group_params:
      custom_args: "discourse_custom_args"
      custom_images: "discourse_custom_images"
      custom_memory: "discourse_custom_memory"
pod_shared_group_params:
  bind_custom_app:
    custom_args: "bind_custom_args"
    custom_images: "bind_custom_images"
    custom_memory: "bind_custom_memory"
    run: "bind_custom_run"
  efk_custom_app:
    custom_args: "efk_custom_args"
    custom_images: "efk_custom_images"
    custom_memory: "efk_custom_memory"
    run: "efk_run"
  efk_custom_external:
    custom_args: "efk_custom_args"
    custom_images: "efk_custom_images"
    custom_memory: "efk_custom_memory"
    run: "efk_run"
  main:
    compose_version: "main_compose_version"
    containers_dict: "main_containers_dict"
    default_logging_dict: "main_default_logging_dict"
    logging_dict: "main_logging_dict"
    managed_volumes_dict: "main_managed_volumes_dict"
    networks_dict: "main_networks_dict"
    services_data_dict: "main_services_data_dict"
    services_dict: "main_services_dict"
    services_command_dict: "main_services_command_dict"
    services_depends_on_dict: "main_services_depends_on_dict"
    services_environment_dict: "main_services_environment_dict"
    services_logging_dict: "main_services_logging_dict"
    services_networks_dict: "main_services_networks_dict"
    services_ports_dict: "main_services_ports_dict"
    services_volumes_dict: "main_services_volumes_dict"
    services_ulimits_dict: "main_services_ulimits_dict"
    volumes_dict: "main_volumes_dict"
  wp_custom_app:
    custom_args: "wp_custom_args"
    custom_domain: "wp_custom_domain"
    custom_images: "wp_custom_images"
    custom_memory: "wp_custom_memory_app"
    meta: "wp_meta"
    run: "wp_custom_run_app"
    run_dict: "wp_run_dict"
  wp_custom_db:
    custom_args: "wp_custom_args"
    custom_domain: "wp_custom_domain"
    custom_images: "wp_custom_images"
    custom_memory: "wp_custom_memory_db"
    meta: "wp_meta"
    run: "wp_custom_run_db"
    run_dict: "wp_run_dict"
  wp_custom_web:
    custom_args: "wp_custom_args"
    custom_domain: "wp_custom_domain"
    custom_images: "wp_custom_images"
    custom_memory: "wp_custom_memory_web"
    meta: "wp_meta"
    run: "wp_custom_run_web"
    run_dict: "wp_run_dict"
  wp_efk_app_pods:
    memory_dict: "wp_efk_app_memory_dict"
pod_params:
  bind_custom_args:
    bind: 
      port: "{{ params.env_params.local | default(false) | bool | ternary('8053', '53') }}"
      zone: "dev.{{ params.env_params.domain }}"
      master_ns: "ns1"      
      slave_ns: "ns2"  
      email_hostmaster: "hostmaster"
      serial: "2020050516"
    fluentd: 
      port: "24224"
  bind_custom_images:
    awscli_image: "lucasbasquerotto/aws-cli"
    awscli_version: "1.0.0"
    bind_image: "lucasbasquerotto/image"
    bind_version: "bind-20200429"
    dnssec_image: "lucasbasquerotto/image"
    dnssec_version: "dnssec-20200504"
    fluentd_image: "lucasbasquerotto/wordpress"
    fluentd_version: "fluentd-1.7.4-01"
    toolbox_image: "lucasbasquerotto/image"
    toolbox_version: "toolbox-20200513"
  bind_custom_memory:
    bind: "512mb"
    dnssec: "512mb" 
    fluentd: "512mb"
    s3_backup: "512mb"
    toolbox: "512mb"
  bind_custom_run:
    tasks:
      backup: ""
      setup: ""
    general:
      orchestration: "compose"
      script_dir: "custom-pod/bind"
      script_env_file: "main.sh"
  discourse_containers_app:
    - name_src: "container.custom.yml"
      name_dest: "app.yml"
      params:
        templates:
          - "templates/postgres.template.yml"
          - "templates/redis.template.yml"
          - "templates/web.template.yml"
          - "templates/web.ratelimited.template.yml"
        expose:
          - "80:80"
          - "443:443"
        params:
          db_default_text_search_config: pg_catalog.english
          db_shared_buffers: 128MB
          version: tests-passed
        env: "{{ params.env_params.discourse_app.env | default({}) }}"
        volumes:
          - volume:
              host: /var/cloud/discourse/data/discourse
              guest: /shared
          - volume:
              host: /var/cloud/discourse/data/log/discourse
              guest: /var/log
        hooks:
          after_code:
            - exec:
                cd: $home/plugins
                cmd:
                  - git clone https://github.com/discourse/docker_manager.git
        run:
          - exec: echo "Beginning of custom commands"
          - exec: echo "End of custom commands"
  discourse_containers_app_static:
    - name_src: "container.custom.yml"
      name_dest: "app.yml"
      params:
        base_image: "{{ params.env_params.discourse_app.base_image | default('') }}"
        templates:
          - "templates/postgres.template.yml"
          - "templates/redis.template.yml"
          - "templates/web.template.validate.yml"
          - "templates/web.template.run.yml"
          - "templates/web.ratelimited.template.yml"
        expose:
          - "80:80"
          - "443:443"
        params:
          db_default_text_search_config: pg_catalog.english
          db_shared_buffers: 128MB
          version: tests-passed
        env: "{{ params.env_params.discourse_app.env | default({}) }}"
        volumes:
          - volume:
              host: /var/cloud/discourse/data/discourse
              guest: /shared
          - volume:
              host: /var/cloud/discourse/data/log/discourse
              guest: /var/log
        run:
          - exec: echo "Beginning of custom commands"
          - exec: echo "End of custom commands"
  discourse_containers_custom: "{{ params.env_params.discourse.custom_containers | default({}) }}"
  discourse_containers_db:
    - name_src: "container.custom.yml"
      name_dest: "app.yml"
      params:
        templates:
          - "templates/postgres.template.yml"
        expose:
          - "5432:5432"
        params:
          db_default_text_search_config: "pg_catalog.english"
          db_shared_buffers: "128MB"
        env: "{{ params.env_params.discourse_db.env | default({}) }}"
        volumes:
          - volume:
              host: /var/cloud/discourse/data/discourse
              guest: /shared
          - volume:
              host: /var/cloud/discourse/data/log/discourse
              guest: /var/log
        hooks:
          after_postgres:
            - exec:
                stdin: |
                  alter user discourse with password '{{ params.env_params.discourse_db.credentials.db_pass | default("") }}';
                cmd: su - postgres -c 'psql discourse'
                raise_on_fail: false
  discourse_containers_redis:
    - name_src: "container.custom.yml"
      name_dest: "app.yml"
      params:
        templates:
          - "templates/redis.template.yml"
        expose:
          - "6379:6379"
        env: "{{ params.env_params.discourse_redis.env | default({}) }}"
        volumes:
          - volume:
              host: /var/cloud/discourse/data/discourse
              guest: /shared
          - volume:
              host: /var/cloud/discourse/data/log/discourse
              guest: /var/log
  discourse_containers_web:
    - name_src: "container.custom.yml"
      name_dest: "app.yml"
      params:
        templates:
          - "templates/web.template.yml"
          - "templates/web.ratelimited.template.yml"
        expose:
          - "80:80"
          - "443:443"
        params:
          db_default_text_search_config: pg_catalog.english
          db_shared_buffers: 128MB
          version: tests-passed
        env: "{{ params.env_params.discourse_web.env | default({}) }}"
        volumes:
          - volume:
              host: /var/cloud/discourse/data/discourse
              guest: /shared
          - volume:
              host: /var/cloud/discourse/data/log/discourse
              guest: /var/log
        hooks:
          after_code:
            - exec:
                cd: $home/plugins
                cmd:
                  - git clone https://github.com/discourse/docker_manager.git
        run:
          - exec: echo "Beginning of custom commands"
          - exec: echo "End of custom commands"
  discourse_containers_web_static:
    - name_src: "container.custom.yml"
      name_dest: "app.yml"
      params:
        base_image: "{{ params.env_params.discourse_web.base_image | default('') }}"
        templates:
          - "templates/web.template.yml"
          - "templates/web.ratelimited.template.yml"
        expose:
          - "80:80"
          - "443:443"
        params:
          db_default_text_search_config: pg_catalog.english
          db_shared_buffers: 128MB
          version: tests-passed
        env: "{{ params.env_params.discourse_web.env | default({}) }}"
        volumes:
          - volume:
              host: /var/cloud/discourse/data/discourse
              guest: /shared
          - volume:
              host: /var/cloud/discourse/data/log/discourse
              guest: /var/log
        hooks:
          after_code:
            - exec:
                cd: $home/plugins
                cmd:
                  - git clone https://github.com/discourse/docker_manager.git
        run:
          - exec: echo "Beginning of custom commands"
          - exec: echo "End of custom commands"
  discourse_containers_multicontainer:
    - name_src: "container.custom.yml"
      name_dest: "db.yml"
      params:
        templates:
          - "templates/postgres.template.yml"
        expose:
          - "5432:5432"
        params:
          db_default_text_search_config: "pg_catalog.english"
          db_shared_buffers: "128MB"
        env: "{{ params.env_params.discourse_db.env | default({}) }}"
        volumes:
          - volume:
              host: /var/cloud/discourse/data/discourse/db
              guest: /shared
          - volume:
              host: /var/cloud/discourse/data/log/discourse/db
              guest: /var/log
        hooks:
          after_postgres:
            - exec:
                stdin: |
                  alter user discourse with password '{{ params.env_params.discourse_db.credentials.db_pass | default("") }}';
                cmd: su - postgres -c 'psql discourse'
                raise_on_fail: false
    - name_src: "container.custom.yml"
      name_dest: "redis.yml"
      params:
        templates:
          - "templates/redis.template.yml"
        expose:
          - "6379:6379"
        env: "{{ params.env_params.discourse_redis.env | default({}) }}"
        volumes:
          - volume:
              host: /var/cloud/discourse/data/discourse/redis
              guest: /shared
          - volume:
              host: /var/cloud/discourse/data/log/discourse/redis
              guest: /var/log
    - name_src: "container.custom.yml"
      name_dest: "web.yml"
      params:
        templates:
          - "templates/web.template.yml"
          - "templates/web.ratelimited.template.yml"
        expose:
          - "80:80"
          - "443:443"
        links:
          - link:
              name: db
              alias: db
          - link:
              name: redis
              alias: redis
        params:
          db_default_text_search_config: pg_catalog.english
          db_shared_buffers: 128MB
          version: tests-passed
        env: "{{ params.env_params.discourse_web.env | default({}) }}"
        volumes:
          - volume:
              host: /var/cloud/discourse/data/discourse/web
              guest: /shared
          - volume:
              host: /var/cloud/discourse/data/log/discourse/web
              guest: /var/log
        run:
          - exec: echo "Beginning of custom commands"
          - exec: echo "End of custom commands"
  discourse_containers_bootstrap:
    - name_src: "container.custom.yml"
      name_dest: "web.yml"
      params:
        templates:
          - "templates/web.template.build.yml"
        params:
          db_default_text_search_config: "pg_catalog.english"
          db_shared_buffers: "128MB"
        volumes:
          - volume:
              host: /var/cloud/discourse/data/discourse/web
              guest: /shared
          - volume:
              host: /var/cloud/discourse/data/log/discourse/web
              guest: /var/log
  discourse_custom_args:
    fluentd: 
      port: "24224"
  discourse_custom_images:
    toolbox_image: "lucasbasquerotto/image"
    toolbox_version: "toolbox-20200513"
    awscli_image: "lucasbasquerotto/aws-cli"
    awscli_version: "1.0.0"
    postgres_image: "postgres"
    postgres_version: "12.2"
    fluentd_image: "lucasbasquerotto/wordpress"
    fluentd_version: "fluentd-1.7.4-01"
  discourse_custom_memory:
    toolbox: 512mb
    postgres: 256mb
    fluentd: 256mb
    s3_backup: 512mb
  discourse_run_bootstrap:
    tasks:
      setup: ""
    general:
      backup_delete_old_days: 30
      backup_local_base_dir: "/tmp/main/backup"
      orchestration: "compose"
      script_dir: "custom-pod/discourse/scripts"
      script_env_file: "main.sh"
      toolbox_service: "toolbox"
    discourse_bootstrap_web: "{{ params.env_params.discourse_bootstrap_web | default({}) }}"
  discourse_run:
    tasks:
      setup: "setup:task:db,backup:ctx:db"
      backup: "backup:task:logs" 
      verify: "verify:db:connection:main" 
    general:
      backup_delete_old_days: 30
      backup_local_base_dir: "/tmp/main/backup"
      orchestration: "compose"
      script_dir: "custom-pod/discourse/scripts"
      script_env_file: "main.sh"
      toolbox_service: "toolbox"
    db_main:
      db_service: "postgres"
      db_cmd: "run"
      db_host: "db"
      db_name: "discourse"
      db_user: "discourse"
      db_connect_wait_secs: 600
    verify_db_connection_main:
     db_task_name: "db:connection:pg"
    backup_task_logs:
      task_name_remote: "backup:remote:default:logs"
      backup_src_base_dir: "/var/log"
    backup_remote_logs:
      task_kind: "dir"
      task_name_s3: "s3:task:backup"
      backup_src_dir: "main"
      backup_bucket_sync: "true"
      backup_bucket_sync_dir: "log"
    setup_task_db:
      task_name_verify: "setup:verify:default:db"
      task_name_remote: "setup:remote:default:db"
      setup_dest_base_dir: "/var/main/data/discourse/backups/default"
    setup_verify_db:
      setup_dest_dir_to_verify: "/var/main/data/discourse/backups/default"
    setup_remote_db:
      task_kind: "file"
      restore_dest_file: "{{ params.env_params.discourse_restore_filename | default('') }}"
      restore_tmp_dir: "/tmp/main/restore/discourse"
      restore_remote_file: "https://github.com/lucasbasquerotto/my-projects/blob/master/discourse/{{ params.env_params.discourse_restore_filename | default('') }}?raw=true"
      restore_recursive_mode_dir: "777"
      restore_recursive_mode_file: "666"
    backup_ctx_db:
      task_names: "backup:task:db" 
    backup_task_db:
      task_name_remote: "backup:remote:default:db"
      backup_src_base_dir: "/var/main/data/discourse/backups/default"
    backup_remote_db:
      task_kind: "file"
      task_name_s3: "s3:task:backup"
      backup_src_file: "{{ params.env_params.discourse_restore_filename | default('') }}"
      backup_bucket_sync: "true"
    s3_backup:
      endpoint: "{{ params.env_params.discourse_backup_bucket.endpoint | default('') }}"
      bucket_name: "{{ params.env_params.discourse_backup_bucket.name | default('') }}"
      bucket_path: "{{ params.env_params.discourse_backup_bucket.path | default('') }}"
      service: "s3_backup"
      cli: "awscli"
      cli_cmd: "run"
    restore:
      container_name: "app"
      filename: "{{ params.env_params.discourse_restore_filename | default('') }}"
  efk_custom_args:
    fluentd: 
      port: "24224"
    elasticsearch:
      port: "9200"
      java_opts: "-Xms1g -Xmx1g"
    kibana:
      port: "5601"
  efk_custom_images:
    fluentd_image: "lucasbasquerotto/wordpress"
    fluentd_version: "fluentd-1.7.4-01"
    elasticsearch_image: "docker.elastic.co/elasticsearch/elasticsearch"
    elasticsearch_version: "7.5.0"
    kibana_image: "docker.elastic.co/kibana/kibana"
    kibana_version: "7.5.0"
  efk_custom_memory:
    fluentd: "512mb"
    elasticsearch: "2gb"
    kibana: "1gb"
  efk_memory_dict:
    1gb:
      fluentd:
        mem_limit: "128mb"
      elasticsearch:
        mem_limit: "512mb"
        environment:
          ES_JAVA_OPTS: -Xms256m -Xmx256m
      kibana:
        mem_limit: "256mb"
    2gb:
      fluentd:
        mem_limit: "256mb"
      elasticsearch:
        mem_limit: "1gb"
        environment:
          ES_JAVA_OPTS: -Xms512m -Xmx512m
      kibana:
        mem_limit: "512mb"
    4gb:
      fluentd:
        mem_limit: "512mb"
      elasticsearch:
        mem_limit: "2gb"
        environment:
          ES_JAVA_OPTS: -Xms1g -Xmx1g
      kibana:
        mem_limit: "1gb"
    8gb:
      fluentd:
        mem_limit: "1gb"
      elasticsearch:
        mem_limit: "4gb"
        environment:
          ES_JAVA_OPTS: -Xms3g -Xmx3g
      kibana:
        mem_limit: "2gb"
    16gb:
      fluentd:
        mem_limit: "2gb"
      elasticsearch:
        mem_limit: "8gb"
        environment:
          ES_JAVA_OPTS: -Xms6g -Xmx6g
      kibana:
        mem_limit: "4gb"
    32gb:
      fluentd:
        mem_limit: "4gb"
      elasticsearch:
        mem_limit: "16gb"
        environment:
          ES_JAVA_OPTS: -Xms12g -Xmx12g
      kibana:
        mem_limit: "8gb"
  efk_run:
    tasks:
      backup: ""
      setup: ""
    general:
      orchestration: "compose"
      script_dir: "custom-pod/efk"
      script_env_file: "main.sh"
  efk_run_dynamic:
    tasks:
      backup: ""
      setup: ""
    general:
      orchestration: "compose"
      script_dir: "main/log/scripts"
      script_env_file: "efk.sh"
  main_compose_version: "2.4"
  main_containers_dict:
    nginx:
      wordpress:
        ssl: "{{ params.env_params.ssl | default(false) }}"
        port: "{{ params.env_params.ssl | default(false) | bool | ternary(443, 80) }}"
        external_port: >-
          {{ 
          params.env_params.local | default(false) | bool | 
          ternary(
          params.env_params.ssl | default(false) | bool | ternary(8443, 8080),
          params.env_params.ssl | default(false) | bool | ternary(443, 80)
          ) 
          }}
      phpmyadmin:
        ssl: "{{ params.env_params.ssl | default(false) }}"
        port: "{{ params.env_params.ssl | default(false) | bool | ternary(9443, 9080) }}"
    wordpress:
      env: >-
        {{ 
        params.env_params.local | default(false) | bool | 
        ternary('development', 'staging') 
        }}
      domain: "{{ params.env_params.wp_full_domain | default('') }}"
    phpmyadmin:
      domain: "{{ params.env_params.wp_full_domain | default('') }}"
    mysql:
      host: "mysql"
      port: "3306"
    fluentd:
      flush_interval: "1s"
    elasticsearch:
      port: "9200"
  main_default_logging_dict:
    log: "json"
    wp_efk: "fluentd"
    wp_app: "json"
  main_logging_dict:
    json:
      driver: "json-file"
      options:
        max-size: "50m"
    fluentd:
      driver: "fluentd"
      options:
        fluentd-address: "localhost:24224"
        tag: !unsafe "docker.{{.Name}}.{{.ID}}"
  main_managed_volumes_dict:
    mysql: {}
  main_networks_dict:
    log:
      driver: bridge
    internet:
      driver: "bridge"
    local:
      driver: "bridge"
      internal: true
  main_services_dict:
    composer:
      args:
        IMAGE: "lucasbasquerotto/wordpress"
        VERSION: "composer-1.8.6"
      working_dir: /var/www/html
    elasticsearch:
      args:
        IMAGE: "docker.elastic.co/elasticsearch/elasticsearch"
        VERSION: "7.5.0"
    fluentd:
      args:
        IMAGE: "lucasbasquerotto/wordpress"
        VERSION: "fluentd-1.7.4-01"
    kibana:
      args:
        IMAGE: "docker.elastic.co/kibana/kibana"
        VERSION: "7.5.0"
    mysql:
      args:
        IMAGE: "lucasbasquerotto/wordpress"
        VERSION: "mysql-8.0.16-02"
      environment:
        MYSQL_ROOT_PASSWORD: $MYSQL_ROOT_PASSWORD
        MYSQL_DATABASE: $DB_NAME
        MYSQL_USER: $DB_USER
        MYSQL_PASSWORD: $DB_PASSWORD
    nginx:
      args:
        IMAGE: "nginx"
        VERSION: "1.14.2-alpine"
    phpmyadmin:
      args:
        IMAGE: "phpmyadmin/phpmyadmin"
        VERSION: "4.8.5"
      environment:
        PMA_HOST: $DB_HOST
        PMA_PORT: $DB_PORT
    toolbox:
      args:
        IMAGE: "lucasbasquerotto/wordpress"
        VERSION: "toolbox-ubuntu-18.04-20190925"
      command: "tail -f /dev/null"
    wordpress:
      args:
        IMAGE: "lucasbasquerotto/wordpress"
        VERSION: "0.0.2"
        WORDPRESS_INI_FILE_TYPE: "development"
      environment:
        DB_HOST: $DB_HOST:$DB_PORT
        DB_NAME: $DB_NAME
        DB_USER: $DB_USER 
      extra_hosts:
      - "test1:1.1.1.1"
      - "test2:2.2.2.2"
    wordpress_local:
      args:
        IMAGE: "lucasbasquerotto/wordpress"
        VERSION: "0.0.2"
        WORDPRESS_INI_FILE_TYPE: development
      environment:
        DB_HOST: $DB_HOST:$DB_PORT
        DB_NAME: $DB_NAME
        DB_USER: $DB_USER
  main_services_data_dict:
    wp_s3_backup:
      s3_cli: "awscli"
      s3_endpoint: "{{ params.env_params.wp_backup_bucket.endpoint | default('') }}"
      bucket:
        access_key: "{{ params.credentials[params.env_params.wp_backup_bucket.credentials | default('')].access_key | default('') }}"
        secret_key: "{{ params.credentials[params.env_params.wp_backup_bucket.credentials | default('')].secret_key | default('') }}"
    wp_s3_uploads:
      s3_cli: "awscli"
      s3_endpoint: "{{ params.env_params.wp_uploads_bucket.endpoint | default('') }}"
      bucket:
        access_key: "{{ params.credentials[params.env_params.wp_uploads_bucket.credentials | default('')].access_key | default('') }}"
        secret_key: "{{ params.credentials[params.env_params.wp_uploads_bucket.credentials | default('')].secret_key | default('') }}"
  main_services_command_dict:
    composer: "tail -f /dev/null"
  main_services_depends_on_dict:
    nginx:
    - "wordpress"
    - "phpmyadmin"
    nginx_web:
    - "wordpress"
    - "phpmyadmin"
    - "fluentd"
    wordpress_app:
    - "mysql"
    wordpress_web:
    - "fluentd"
    phpmyadmin_app:
    - "mysql"
    phpmyadmin_web:
    - "fluentd"
    toolbox_web:
    - "fluentd"
    toolbox_db:
    - "fluentd"
    mysql_db:
    - "fluentd"
    fluentd_app:
    - "elasticsearch"
    kibana_app:
    - "elasticsearch"
    kibana_web:
    - "elasticsearch"
  main_services_environment_dict:
    elasticsearch:
      cluster.initial_master_nodes: elasticsearch
  main_services_logging_dict:
    elasticsearch: "json"
    fluentd: "json"
  main_services_networks_dict:
    nginx:
    - "internet"
    - "local"
    wordpress:
    - "internet"
    - "local"
    phpmyadmin:
    - "internet"
    - "local"
    phpmyadmin_app:
    - "local"
    mysql:
    - "internet"
    - "local"
    mysql_app:
    - "local"
    toolbox:
    - "internet"
    - "local"
    fluentd:
    - "log"
    elasticsearch:
    - "log"
    kibana:
    - "log"
  main_services_ports_dict:
    nginx:
    - "{{ params.env_params.local | default(false) | bool | ternary('8080:80', '80:80') }}"
    - "{{ params.env_params.local | default(false) | bool | ternary('8443:443', '443:443') }}"
    - "9080:9080"
    - "9443:9443"
    mysql_db:
    - "3306:3306"
    fluentd:
    - "24224:24224"
    - "24224:24224/udp"
    elasticsearch:
    - "9200:9200"
    kibana:
    - "5601:5601"
  main_services_volumes_dict:
    nginx:
    - "$DATA_DIR/tmp/nginx:/tmp/main/nginx"
    wordpress:
    - "$DATA_DIR/wordpress/uploads:/var/www/html/web/app/uploads"
    - "$DATA_DIR/tmp/wordpress:/tmp/main/wordpress"
    wordpress_local:
    - "$WP_APP_REPO_DIR:/var/www/html"
    - "$DATA_DIR/wordpress/uploads:/var/www/html/web/app/uploads"
    - "$DATA_DIR/tmp/wordpress:/tmp/main/wordpress"
    phpmyadmin:
    - "$DATA_DIR/tmp/phpmyadmin:/tmp/main/phpmyadmin"
    mysql:
    - "$DATA_DIR/mysql:/var/lib/mysql"
    - "$DATA_DIR/tmp/mysql:/tmp/main/mysql"
    mysql_local:
    - "mysql:/var/lib/mysql"
    - "$DATA_DIR/tmp/mysql:/tmp/main/mysql"
    composer:
    - "$WP_APP_REPO_DIR:/var/www/html"
    - "$DATA_DIR/tmp/composer:/tmp/main/composer"
    toolbox:
    - "$DATA_DIR:/var/main/data"
    - "$DATA_DIR/tmp:/tmp/main"
    elasticsearch:
    - "$DATA_DIR/elasticsearch:/usr/share/elasticsearch/data"
  main_services_ulimits_dict:
    elasticsearch:
      memlock:
        soft: -1
        hard: -1
  main_volumes_dict:
    test_local_1:
      rel_path: "test_local_1"
      mode: "0777"
    test_local_2:
      rel_path: "test_local_2"
      mode: "0777"
    test_remote_1:
      rel_path: "test_remote_1"
      mode: "0777"
    test_remote_2:
      rel_path: "test_remote_2"
      mode: "0777"
  wp_app_memory_dict:
    1gb:
      nginx:
        mem_limit: "128mb"
      wordpress:
        mem_limit: "128mb"
      phpmyadmin:
        mem_limit: "128mb"
      mysql:
        mem_limit: "512mb"
      toolbox:
        mem_limit: "128mb"
      composer:
        mem_limit: "128mb"
    2gb:
      nginx:
        mem_limit: "256mb"
      wordpress:
        mem_limit: "256mb"
      phpmyadmin:
        mem_limit: "256mb"
      mysql:
        mem_limit: "1gb"
      toolbox:
        mem_limit: "256mb"
      composer:
        mem_limit: "256mb"
    4gb:
      nginx:
        mem_limit: "512mb"
      wordpress:
        mem_limit: "512mb"
      phpmyadmin:
        mem_limit: "512mb"
      mysql:
        mem_limit: "1gb"
      toolbox:
        mem_limit: "512mb"
      composer:
        mem_limit: "512mb"
    8gb:
      nginx:
        mem_limit: "1gb"
      wordpress:
        mem_limit: "1gb"
      phpmyadmin:
        mem_limit: "1gb"
      mysql:
        mem_limit: "2gb"
      toolbox:
        mem_limit: "1gb"
      composer:
        mem_limit: "1gb"
    16gb:
      nginx:
        mem_limit: "2gb"
      wordpress:
        mem_limit: "2gb"
      phpmyadmin:
        mem_limit: "2gb"
      mysql:
        mem_limit: "4gb"
      toolbox:
        mem_limit: "2gb"
      composer:
        mem_limit: "2gb"
    32gb:
      nginx:
        mem_limit: "4gb"
      wordpress:
        mem_limit: "4gb"
      phpmyadmin:
        mem_limit: "4gb"
      mysql:
        mem_limit: "8gb"
      toolbox:
        mem_limit: "4gb"
      composer:
        mem_limit: "4gb"
  wp_db_memory_dict:
    1gb:
      mysql:
        mem_limit: "512mb"
      toolbox:
        mem_limit: "256mb"
    2gb:
      mysql:
        mem_limit: "1gb"
      toolbox:
        mem_limit: "512mb"
    4gb:
      mysql:
        mem_limit: "2gb"
      toolbox:
        mem_limit: "1gb"
    8gb:
      mysql:
        mem_limit: "4gb"
      toolbox:
        mem_limit: "2gb"
    16gb:
      mysql:
        mem_limit: "8gb"
      toolbox:
        mem_limit: "4gb"
    32gb:
      mysql:
        mem_limit: "16gb"
      toolbox:
        mem_limit: "8gb"
  wp_custom_args:
    mysql:
      host: "mysql"
      port: "3306"
    wordpress:
      app_name: "wp_local"
      env: >-
        {{ 
        params.env_params.local | default(false) | bool | 
        ternary('development', 'staging') 
        }}
      lang: "en_US"
    fluentd: 
      port: "24224"
  wp_custom_domain:
    main_domain: "{{ params.env_params.wp_full_domain | default('') }}"
    main_port: >-
      {{ 
      params.env_params.local | default(false) | bool | 
      ternary(
      params.env_params.ssl | default(false) | bool | ternary(8443, 8080),
      params.env_params.ssl | default(false) | bool | ternary(443, 80)
      ) 
      }}
    main_ssl: "{{ params.env_params.ssl | default(false) }}"
    pma_domain: "{{ params.env_params.wp_full_domain | default('') }}"
    pma_port: "{{ params.env_params.ssl | default(false) | bool | ternary(9443, 9080) }}"
    pma_ssl: "{{ params.env_params.ssl | default(false) }}"
  wp_custom_images:
    nginx_image: "nginx"
    nginx_version: "1.14.2-alpine"
    wordpress_image: "lucasbasquerotto/wordpress"
    wordpress_version: "0.0.2"
    pma_image: "phpmyadmin/phpmyadmin"
    pma_version: "4.8.5"
    mysql_image: "lucasbasquerotto/wordpress"
    mysql_version: "mysql-8.0.16-02"
    toolbox_image: "lucasbasquerotto/image"
    toolbox_version: "toolbox-20200513"
    composer_image: "lucasbasquerotto/wordpress"
    composer_version: "composer-1.8.6"
    awscli_image: "lucasbasquerotto/aws-cli"
    awscli_version: "1.0.0"
    fluentd_image: "lucasbasquerotto/wordpress"
    fluentd_version: "fluentd-1.7.4-01"
  wp_custom_memory_app:
    nginx: 512mb
    wordpress: 512mb
    pma: 512mb
    mysql: 1gb
    toolbox: 512mb
    composer: 512mb
    fluentd: 256mb
    s3_uploads: 512mb
    s3_backup: 512mb
  wp_custom_memory_db:
    mysql: 1gb
    toolbox: 512mb
    fluentd: 256mb
    s3_backup: 512mb
  wp_custom_memory_web:
    nginx: 512mb
    wordpress: 512mb
    pma: 512mb
    toolbox: 512mb
    fluentd: 256mb
    composer: 512mb
    s3_uploads: 512mb
    s3_backup: 512mb
  wp_custom_run_app:
    tasks: >-
      {{ 
      params.env_params.local | default(false) | bool |
      ternary('tasks_app_custom_local', 'tasks_app_custom') 
      }}
    general: "general"
    migrate: "migrate"
    setup_task_wp_uploads: "setup_task_wp_uploads"
    setup_verify_wp_uploads: "setup_verify_wp_uploads"
    setup_remote_wp_uploads: "setup_remote_wp_uploads_file"
    backup_task_wp_uploads: "backup_task_wp_uploads"
    backup_remote_wp_uploads: "backup_remote_wp_uploads_sync_dir"
    s3_wp_uploads: "s3_wp_uploads"
    setup_task_wp_db: "setup_task_wp_db_restore"
    setup_verify_wp_db: "setup_verify_wp_db"
    setup_remote_wp_db: "setup_remote_wp_db_file"
    setup_local_wp_db: "setup_local_wp_db"
    backup_task_wp_db: "backup_task_wp_db"
    backup_remote_wp_db: "backup_remote_wp_db_sync_dir"
    backup_local_wp_db: "backup_local_wp_db"
    db_wp_db: "db_wp_db"
    s3_wp_db: "s3_wp_db"
    setup_task_logs: "setup_task_logs"
    setup_verify_logs: "setup_verify_logs"
    setup_remote_logs: "setup_remote_logs_bucket_path_dir"
    backup_task_logs: "backup_task_logs"
    backup_remote_logs: "backup_remote_logs_sync_dir"
    s3_logs: "s3_logs"
  wp_custom_run_db:
    tasks: "tasks_db"
    general: "general"
    migrate: "migrate"
    setup_task_wp_db: "setup_task_wp_db_restore"
    setup_verify_wp_db: "setup_verify_wp_db"
    setup_remote_wp_db: "setup_remote_wp_db_file"
    setup_local_wp_db: "setup_local_wp_db"
    backup_task_wp_db: "backup_task_wp_db"
    backup_remote_wp_db: "backup_remote_wp_db_sync_dir"
    backup_local_wp_db: "backup_local_wp_db"
    db_wp_db: "db_wp_db"
    s3_wp_db: "s3_wp_db"
  wp_custom_run_web:
    tasks: "tasks_web"
    general: "general"
    migrate: "migrate"
    setup_task_wp_uploads: "setup_task_wp_uploads"
    setup_verify_wp_uploads: "setup_verify_wp_uploads"
    setup_remote_wp_uploads: "setup_remote_wp_uploads_file"
    backup_task_wp_uploads: "backup_task_wp_uploads"
    backup_remote_wp_uploads: "backup_remote_wp_uploads_sync_dir"
    s3_wp_uploads: "s3_wp_uploads"
  wp_efk_app_memory_dict:
    2gb:
      fluentd:
        mem_limit: "128mb"
      elasticsearch:
        mem_limit: "512mb"
        environment:
          ES_JAVA_OPTS: -Xms256m -Xmx256m
      kibana:
        mem_limit: "256mb"
      nginx:
        mem_limit: "128mb"
      wordpress:
        mem_limit: "128mb"
      phpmyadmin:
        mem_limit: "128mb"
      mysql:
        mem_limit: "256mb"
      toolbox:
        mem_limit: "128mb"
      composer:
        mem_limit: "128mb"
    4gb:
      fluentd:
        mem_limit: "256mb"
      elasticsearch:
        mem_limit: "1gb"
        environment:
          ES_JAVA_OPTS: -Xms512m -Xmx512m
      kibana:
        mem_limit: "512mb"
      nginx:
        mem_limit: "256mb"
      wordpress:
        mem_limit: "256mb"
      phpmyadmin:
        mem_limit: "256mb"
      mysql:
        mem_limit: "512mb"
      toolbox:
        mem_limit: "256mb"
      composer:
        mem_limit: "256mb"
    8gb:
      fluentd:
        mem_limit: "512mb"
      elasticsearch:
        mem_limit: "2gb"
        environment:
          ES_JAVA_OPTS: -Xms1g -Xmx1g
      kibana:
        mem_limit: "1gb"
      nginx:
        mem_limit: "512mb"
      wordpress:
        mem_limit: "512mb"
      phpmyadmin:
        mem_limit: "512mb"
      mysql:
        mem_limit: "1gb"
      toolbox:
        mem_limit: "512mb"
      composer:
        mem_limit: "512mb"
    16gb:
      fluentd:
        mem_limit: "1gb"
      elasticsearch:
        mem_limit: "4gb"
        environment:
          ES_JAVA_OPTS: -Xms3g -Xmx3g
      kibana:
        mem_limit: "2gb"
      nginx:
        mem_limit: "1gb"
      wordpress:
        mem_limit: "1gb"
      phpmyadmin:
        mem_limit: "1gb"
      mysql:
        mem_limit: "2gb"
      toolbox:
        mem_limit: "1gb"
      composer:
        mem_limit: "1gb"
    32gb:
      fluentd:
        mem_limit: "2gb"
      elasticsearch:
        mem_limit: "8gb"
        environment:
          ES_JAVA_OPTS: -Xms6g -Xmx6g
      kibana:
        mem_limit: "4gb"
      nginx:
        mem_limit: "2gb"
      wordpress:
        mem_limit: "2gb"
      phpmyadmin:
        mem_limit: "2gb"
      mysql:
        mem_limit: "4gb"
      toolbox:
        mem_limit: "2gb"
      composer:
        mem_limit: "2gb"
  wp_meta:
    use_run_dict: true
  wp_run_dynamic_app:
    tasks: "tasks_app_dynamic"
    general: "general_dynamic"
    migrate: "migrate"
    setup_task_wp_uploads: "setup_task_wp_uploads"
    setup_verify_wp_uploads: "setup_verify_wp_uploads"
    setup_remote_wp_uploads: "setup_remote_wp_uploads_file"
    backup_task_wp_uploads: "backup_task_wp_uploads"
    backup_remote_wp_uploads: "backup_remote_wp_uploads_sync_dir"
    s3_wp_uploads: "s3_wp_uploads"
    setup_task_wp_db: "setup_task_wp_db_restore"
    setup_verify_wp_db: "setup_verify_wp_db"
    setup_remote_wp_db: "setup_remote_wp_db_file"
    setup_local_wp_db: "setup_local_wp_db"
    backup_task_wp_db: "backup_task_wp_db"
    backup_remote_wp_db: "backup_remote_wp_db_sync_dir"
    backup_local_wp_db: "backup_local_wp_db"
    db_wp_db: "db_wp_db"
    s3_wp_db: "s3_wp_db"
  wp_run_dynamic_db:
    tasks: "tasks_db"
    general: "general_dynamic"
    migrate: "migrate"
    setup_task_wp_db: "setup_task_wp_db_restore"
    setup_verify_wp_db: "setup_verify_wp_db"
    setup_remote_wp_db: "setup_remote_wp_db_file"
    setup_local_wp_db: "setup_local_wp_db"
    backup_task_wp_db: "backup_task_wp_db"
    backup_remote_wp_db: "backup_remote_wp_db_sync_dir"
    backup_local_wp_db: "backup_local_wp_db"
    db_wp_db: "db_wp_db"
    s3_wp_db: "s3_wp_db"
  wp_run_dynamic_web:
    tasks: "tasks_web"
    general: "general_dynamic"
    migrate: "migrate"
    setup_task_wp_uploads: "setup_task_wp_uploads"
    setup_verify_wp_uploads: "setup_verify_wp_uploads"
    setup_remote_wp_uploads: "setup_remote_wp_uploads_file"
    backup_task_wp_uploads: "backup_task_wp_uploads"
    backup_remote_wp_uploads: "backup_remote_wp_uploads_sync_dir"
    s3_wp_uploads: "s3_wp_uploads"
  wp_run_setup_remote_backup_sync:
    tasks: "tasks_app_dynamic"
    general: "general_dynamic"
    migrate: "migrate"
    setup_task_wp_uploads: "setup_task_wp_uploads"
    setup_verify_wp_uploads: "setup_verify_wp_uploads"
    setup_remote_wp_uploads: "setup_remote_wp_uploads_file"
    backup_task_wp_uploads: "backup_task_wp_uploads"
    backup_remote_wp_uploads: "backup_remote_wp_uploads_sync_dir"
    s3_wp_uploads: "s3_wp_uploads"
    setup_task_wp_db: "setup_task_wp_db_restore"
    setup_verify_wp_db: "setup_verify_wp_db"
    setup_remote_wp_db: "setup_remote_wp_db_file"
    setup_local_wp_db: "setup_local_wp_db"
    backup_task_wp_db: "backup_task_wp_db"
    backup_remote_wp_db: "backup_remote_wp_db_sync_dir"
    backup_local_wp_db: "backup_local_wp_db"
    db_wp_db: "db_wp_db"
    s3_wp_db: "s3_wp_db"
  wp_run_setup_bucket_dir_backup_no_sync:
    tasks: "tasks_app_dynamic"
    general: "general_dynamic"
    migrate: "migrate"
    setup_task_wp_uploads: "setup_task_wp_uploads"
    setup_verify_wp_uploads: "setup_verify_wp_uploads"
    setup_remote_wp_uploads: "setup_remote_wp_uploads_bucket_path_dir"
    backup_task_wp_uploads: "backup_task_wp_uploads"
    backup_remote_wp_uploads: "backup_remote_wp_uploads_no_sync"
    s3_wp_uploads: "s3_wp_uploads"
    setup_task_wp_db: "setup_task_wp_db_restore"
    setup_verify_wp_db: "setup_verify_wp_db"
    setup_remote_wp_db: "setup_remote_wp_db_bucket_path_dir"
    setup_local_wp_db: "setup_local_wp_db"
    backup_task_wp_db: "backup_task_wp_db"
    backup_remote_wp_db: "backup_remote_wp_db_no_sync"
    backup_local_wp_db: "backup_local_wp_db"
    db_wp_db: "db_wp_db"
    s3_wp_db: "s3_wp_db"
  wp_run_setup_bucket_file_backup_sync:
    tasks: "tasks_app_dynamic"
    general: "general_dynamic"
    migrate: "migrate"
    setup_task_wp_uploads: "setup_task_wp_uploads"
    setup_verify_wp_uploads: "setup_verify_wp_uploads"
    setup_remote_wp_uploads: "setup_remote_wp_uploads_bucket_path_file"
    backup_task_wp_uploads: "backup_task_wp_uploads"
    backup_remote_wp_uploads: "backup_remote_wp_uploads_sync_dir_2"
    s3_wp_uploads: "s3_wp_uploads"
    setup_task_wp_db: "setup_task_wp_db_restore"
    setup_verify_wp_db: "setup_verify_wp_db"
    setup_remote_wp_db: "setup_remote_wp_db_bucket_path_file"
    setup_local_wp_db: "setup_local_wp_db"
    backup_task_wp_db: "backup_task_wp_db"
    backup_remote_wp_db: "backup_remote_wp_db_sync_dir_2"
    backup_local_wp_db: "backup_local_wp_db"
    db_wp_db: "db_wp_db"
    s3_wp_db: "s3_wp_db"
  wp_run_dict:
    tasks_app_custom:
      backup: "backup:task:wp_db,backup:task:wp_uploads,backup:task:logs" 
      setup: "setup:task:logs,setup:task:wp_uploads,setup:task:wp_db" 
    tasks_app_custom_local:
      backup: "backup:task:wp_db,backup:task:wp_uploads" 
      setup: "setup:task:wp_uploads,setup:task:wp_db" 
    tasks_app_dynamic:
      backup: "backup:task:wp_db,backup:task:wp_uploads" 
      setup: "setup:task:wp_uploads,setup:task:wp_db" 
    tasks_db:
      backup: "backup:task:wp_db" 
      setup: "setup:task:wp_db" 
    tasks_web:
      backup: "backup:task:wp_uploads" 
      setup: "setup:task:wp_uploads" 
    general:
      backup_delete_old_days: 3
      backup_local_base_dir: "/tmp/main/backup"
      orchestration: "compose"
      script_dir: "custom-pod/wordpress/scripts"
      script_env_file: >-
        {{ params.env_params.local | default(false) | bool | ternary('local.sh', 'remote.sh') }}
      toolbox_service: "toolbox"
    general_dynamic:
      backup_delete_old_days: 3
      backup_local_base_dir: "/tmp/main/backup"
      orchestration: "compose"
      script_dir: "main/wordpress/scripts"
      script_env_file: >-
        {{ params.env_params.local | default(false) | bool | ternary('local.sh', 'remote.sh') }}
      toolbox_service: "toolbox"
    migrate:
      url: >-
        {{ params.env_params.ssl | default(false) | bool | ternary('https', 'http') 
        }}://{{ params.env_params.wp_full_domain | default('') }}
      title: "{{ params.env_params.wp_title | default('No Title :/') }}"
      admin_user: "{{ params.credentials.wordpress.setup.admin_user | default('') }}"
      admin_password: "{{ params.credentials.wordpress.setup.admin_password | default('') }}"
      admin_email: "{{ params.credentials.wordpress.setup.admin_email | default('') }}"
      restore_seed: true
      remote_seed_data: "https://gist.githubusercontent.com/lucasbasquerotto/667447640482369d0c6b093ee7200c96/raw/9d9d446b9f1017aa4bc12628aea954f1f10f020c/wordpress-theme-unit-test-data.xml"
      old_domain_host: "{{ params.env_params.wp_old_domain_host | default('') }}"
      new_domain_host: "{{ params.env_params.wp_new_domain_host | default('') }}"
    s3_wp_uploads:
      endpoint: "{{ params.env_params.wp_uploads_bucket.endpoint | default('') }}"
      bucket_name: "{{ params.env_params.wp_uploads_bucket.name | default('') }}"
      bucket_path: "{{ params.env_params.wp_uploads_bucket.path | default('') }}"
      service: "wp_s3_uploads"
      cli: "awscli"
      cli_cmd: "run"
    setup_task_wp_uploads:
      task_name_verify: "setup:verify:default:wp_uploads"
      task_name_remote: "setup:remote:default:wp_uploads"
      setup_dest_base_dir: "/var/main/data/wordpress/uploads"
    setup_verify_wp_uploads:
      setup_dest_dir_to_verify: "/var/main/data/wordpress/uploads"
    setup_remote_wp_uploads_file:
      task_kind: "dir"
      restore_tmp_dir: "/tmp/main/restore/wordpress/uploads"
      restore_remote_file: "https://github.com/lucasbasquerotto/my-projects/blob/master/wp/backup-uploads-20190917_195406-1568760846.zip?raw=true"
      restore_is_zip_file: "true"
      restore_zip_pass: "{{ params.credentials.wp_uploads_zip_file_pass | default('') }}"
      restore_recursive_mode_dir: "777"
      restore_recursive_mode_file: "666"
      restore_zip_inner_dir: "uploads"
    setup_remote_wp_uploads_bucket_path_file:
      task_kind: "dir"
      task_name_s3: "s3:task:wp_uploads"
      restore_tmp_dir: "/tmp/main/restore/wordpress/uploads"
      restore_remote_bucket_path_file: "wp-static/wp-uploads.zip"
      restore_is_zip_file: "true"
      restore_zip_pass: "{{ params.credentials.wp_uploads_zip_file_pass | default('') }}"
      restore_recursive_mode_dir: "777"
      restore_recursive_mode_file: "666"
      restore_zip_inner_dir: "uploads"
    setup_remote_wp_uploads_bucket_path_dir:
      task_kind: "dir"
      task_name_s3: "s3:task:wp_uploads"
      restore_tmp_dir: "/tmp/main/restore/wordpress/uploads"
      restore_recursive_mode_dir: "777"
      restore_recursive_mode_file: "666"
      restore_remote_bucket_path_dir: "uploads"
    backup_task_wp_uploads:
      task_name_remote: "backup:remote:default:wp_uploads"
      backup_src_base_dir: "/var/main/data/wordpress"
      backup_local_static_dir:  "/tmp/main/backup/static"
    backup_remote_wp_uploads_no_sync:
      task_kind: "dir"
      task_name_s3: "s3:task:wp_uploads"
      backup_src_dir: "uploads"
      backup_bucket_static_dir: "wp-static"
      backup_zip_file: "wp-uploads.zip"
    backup_remote_wp_uploads_sync_dir:
      task_kind: "dir"
      task_name_s3: "s3:task:wp_uploads"
      backup_src_dir: "uploads"
      backup_bucket_sync: "true"
      backup_bucket_sync_dir: "uploads"
    backup_remote_wp_uploads_sync_dir_2:
      task_kind: "dir"
      task_name_s3: "s3:task:wp_uploads"
      backup_src_dir: "uploads"
      backup_bucket_sync: "true"
      backup_bucket_sync_dir: "uploads2"
    s3_wp_db:
      endpoint: "{{ params.env_params.wp_backup_bucket.endpoint | default('') }}"
      bucket_name: "{{ params.env_params.wp_backup_bucket.name | default('') }}"
      bucket_path: "{{ params.env_params.wp_backup_bucket.path | default('') }}"
      service: "wp_s3_backup"
      cli: "awscli"
      cli_cmd: "run"
    setup_task_wp_db_new_db:
      setup_run_new_task: "true"
      task_name_new: "setup:new:wp_db"
    setup_task_wp_db_restore:
      task_name_verify: "setup:verify:db:wp_db"
      task_name_remote: "setup:remote:default:wp_db"
      task_name_local: "setup:local:db:wp_db"
      setup_dest_base_dir: "/tmp/main/mysql/restore"
    setup_verify_wp_db:
      db_task_name: "db:restore:verify:mysql"
    setup_remote_wp_db_file:
      task_kind: "file"
      restore_dest_file: "{{ params.credentials.wordpress.db.name | default('') }}.sql"
      restore_tmp_dir: "/tmp/main/restore/mysql"
      restore_remote_file: "https://github.com/lucasbasquerotto/my-projects/blob/master/wp/backup-db-20190917_195406-1568760846.zip?raw=true" 
      restore_is_zip_file: "true"
      restore_zip_pass: "{{ params.credentials.wp_db_zip_file_pass | default('') }}"
      restore_zip_inner_file: "{{ params.credentials.wordpress.db.name | default('') }}.sql"
    setup_remote_wp_db_bucket_path_file: 
      task_kind: "file"
      task_name_s3: "s3:task:wp_db"
      restore_dest_file: "{{ params.credentials.wordpress.db.name | default('') }}.sql"
      restore_tmp_dir: "/tmp/main/restore/mysql"
      restore_remote_bucket_path_file: "wp-static/wp-db.zip"
      restore_is_zip_file: "true"
      restore_zip_pass: "{{ params.credentials.wp_db_zip_file_pass | default('') }}"
      restore_zip_inner_file: "{{ params.credentials.wordpress.db.name | default('') }}.sql"
    setup_remote_wp_db_bucket_path_dir: 
      task_kind: "file"
      task_name_s3: "s3:task:wp_db"
      restore_dest_file: "{{ params.credentials.wordpress.db.name | default('') }}.sql"
      restore_tmp_dir: "/tmp/main/restore/mysql"
      restore_remote_bucket_path_dir: "db"
    setup_local_wp_db:
      db_task_name: "db:restore:file:mysql"
      db_sql_file_name: "{{ params.credentials.wordpress.db.name | default('') }}.sql"
    backup_task_wp_db:
      task_name_local: "backup:local:db:wp_db"
      task_name_remote: "backup:remote:default:wp_db"
      backup_src_base_dir: "/tmp/main/mysql/backup"
      backup_local_static_dir:  "/tmp/main/backup/static"
    backup_task_wp_db_dynamic:
      task_name_local: "backup:local:db:wp_db"
      task_name_remote: "backup:remote:default:wp_db"
      backup_src_base_dir: "/tmp/main/mysql/backup"
    backup_remote_wp_db_no_sync:
      task_kind: "file"
      task_name_s3: "s3:task:wp_db"
      backup_src_file: "{{ params.credentials.wordpress.db.name | default('') }}.sql"
      backup_bucket_static_dir: "wp-static"
      backup_zip_file: "wp-db.zip"
    backup_remote_wp_db_sync_dir:
      task_kind: "file"
      task_name_s3: "s3:task:wp_db"
      backup_src_file: "{{ params.credentials.wordpress.db.name | default('') }}.sql"
      backup_bucket_sync: "true"
      backup_bucket_sync_dir: "db"   
    backup_remote_wp_db_sync_dir_2:
      task_kind: "file"
      task_name_s3: "s3:task:wp_db"
      backup_src_file: "{{ params.credentials.wordpress.db.name | default('') }}.sql"
      backup_bucket_sync: "true"
      backup_bucket_sync_dir: "db2"   
    backup_local_wp_db:
      db_task_name: "db:backup:file:mysql"
      db_sql_file_name: "{{ params.credentials.wordpress.db.name | default('') }}.sql"
    db_wp_db:
      db_service: "mysql"
      db_name: "{{ params.credentials.wordpress.db.name | default('') }}"
      db_user: "{{ params.credentials.wordpress.db.user | default('') }}"
      db_pass: "{{ params.credentials.wordpress.db.password | default('') }}"
      db_connect_wait_secs: 90
    s3_logs:
      endpoint: "{{ params.env_params.wp_backup_bucket.endpoint | default('') }}"
      bucket_name: "{{ params.env_params.wp_backup_bucket.name | default('') }}"
      bucket_path: "{{ params.env_params.wp_backup_bucket.path | default('') }}"
      service: "wp_s3_backup"
      cli: "awscli"
      cli_cmd: "run"
    setup_task_logs:
      task_name_verify: "setup:verify:default:logs"
      task_name_remote: "setup:remote:default:logs"
      setup_dest_base_dir: "/var/log/main"
    setup_verify_logs:
      setup_dest_dir_to_verify: "/var/log/main"
    setup_remote_logs_bucket_path_dir:
      task_kind: "dir"
      task_name_s3: "s3:task:logs"
      restore_tmp_dir: "/tmp/main/restore/log"
      restore_recursive_mode_dir: "777"
      restore_recursive_mode_file: "666"
      restore_remote_bucket_path_dir: "logs"
    backup_task_logs:
      task_name_remote: "backup:remote:default:logs"
      backup_src_base_dir: "/var/log"
      backup_local_static_dir:  "/tmp/main/backup/static"
    backup_remote_logs_sync_dir:
      task_kind: "dir"
      task_name_s3: "s3:task:logs"
      backup_src_dir: "main"
      backup_bucket_sync: "true"
      backup_bucket_sync_dir: "log"
  wp_web_memory_dict:
    1gb:
      nginx:
        mem_limit: "128mb"
      wordpress:
        mem_limit: "512mb"
      phpmyadmin:
        mem_limit: "128mb"
      toolbox:
        mem_limit: "128mb"
      composer:
        mem_limit: "128mb"
    2gb:
      nginx:
        mem_limit: "512mb"
      wordpress:
        mem_limit: "1gb"
      phpmyadmin:
        mem_limit: "512mb"
      toolbox:
        mem_limit: "512mb"
      composer:
        mem_limit: "512mb"
    4gb:
      nginx:
        mem_limit: "1gb"
      wordpress:
        mem_limit: "2gb"
      phpmyadmin:
        mem_limit: "1gb"
      toolbox:
        mem_limit: "1gb"
      composer:
        mem_limit: "1gb"
    8gb:
      nginx:
        mem_limit: "2gb"
      wordpress:
        mem_limit: "4gb"
      phpmyadmin:
        mem_limit: "2gb"
      toolbox:
        mem_limit: "2gb"
      composer:
        mem_limit: "2gb"
    16gb:
      nginx:
        mem_limit: "4gb"
      wordpress:
        mem_limit: "8gb"
      phpmyadmin:
        mem_limit: "4gb"
      toolbox:
        mem_limit: "4gb"
      composer:
        mem_limit: "4gb"
    32gb:
      nginx:
        mem_limit: "8gb"
      wordpress:
        mem_limit: "16gb"
      phpmyadmin:
        mem_limit: "8gb"
      toolbox:
        mem_limit: "8gb"
      composer:
        mem_limit: "8gb"
apps:
  wp_local:
    repo: "app"
run_stages:
  all_local_stop: ["all_local_stop"]
  all_local_upgrade: ["all_local_upgrade"]
  backup: ["default_backup_pods"]
  bind_upgrade: ["bind_upgrade"]
  bind_slave_upgrade: ["bind_slave_upgrade"]
  build: ["default_build_pods"]
  clear: ["default_clear_pods"]
  default: ["default_prepare_nodes", "default_build_pods", "default_upgrade_pods"]
  default_discourse_backup: 
  - "default_prepare_nodes"
  - "default_build_pods"
  - "discourse_upgrade_tools"
  - "default_upgrade_pods"
  - "discourse_restore"
  default_nodes: ["default_prepare_nodes", "default_build_pods"]
  discourse_upgrade_non_web: ["discourse_upgrade_non_web"]
  discourse_upgrade_web: 
  - "discourse_upgrade_tools_web"
  - "discourse_wait_db"
  - "discourse_upgrade_web"
  - "discourse_restore_web"
  efk_external_upgrade: ["efk_external_upgrade"]
  nodes: ["default_prepare_nodes"]
  pods: ["default_upgrade_pods"]
  wait: ["default_wait_pods"]
  wp_db_upgrade: ["wp_db_upgrade"]
  wp_efk_app_efk: ["wp_efk_app_wp_stop", "wp_efk_app_efk_upgrade"]
  wp_efk_app_wp: ["wp_efk_app_wp_upgrade"]
  wp_web_stop: ["wp_web_stop"]
  wp_web_upgrade: ["wp_web_upgrade"]
run_stage_tasks:
  bind_upgrade:
    task_tag: "upgrade"
    pods_tasks: true
    nodes: ["bind"]
  bind_slave_upgrade:
    task_tag: "upgrade"
    pods_tasks: true
    nodes: ["bind_slave"]
  default_prepare_nodes:
    task_tag: "prepare"
    nodes_tasks: true
    all_nodes: true
  default_build_pods:
    task_tag: "build"
    pods_tasks: true
    all_nodes: true
  default_upgrade_pods:
    task_tag: "upgrade"
    pods_tasks: true
    all_nodes: true
  default_backup_pods:
    task_tag: "backup"
    pods_tasks: true
    all_nodes: true
  default_wait_pods:
    task_tag: "wait"
    pods_tasks: true
    all_nodes: true
  default_clear_pods:
    task_tag: "clear_all"
    pods_tasks: true
    all_nodes: true
  discourse_restore:
    task_tag: "restore"
    pods_tasks: true
    all_nodes: true
  discourse_restore_web:
    task_tag: "restore"
    pods_tasks: true
    nodes: ["discourse_web"]
  discourse_upgrade_non_web:
    task_tag: "upgrade"
    pods_tasks: true
    nodes: ["discourse_db", "discourse_redis"]
  discourse_upgrade_tools:
    task_tag: "upgrade_tools"
    pods_tasks: true
    all_nodes: true
  discourse_upgrade_tools_web:
    task_tag: "upgrade_tools"
    pods_tasks: true
    nodes: ["discourse_web"]
  discourse_upgrade_web:
    task_tag: "upgrade"
    pods_tasks: true
    nodes: ["discourse_web"]
  discourse_wait_db:
    task_tag: "wait_db"
    pods_tasks: true
    nodes: ["discourse_web"]
  all_local_stop:
    task_tag: "stop_to_upgrade"
    pods_tasks: true
    partial_pods: true
    nodes: ["wp_efk_app_efk", "wp_efk_app_wp"]
  all_local_upgrade:
    task_tag: "upgrade"
    pods_tasks: true
    nodes: ["efk_local", "wp_web", "wp_db"]
  efk_external_upgrade:
    task_tag: "upgrade"
    pods_tasks: true
    nodes: ["efk"]
  wp_efk_app_wp_stop:
    task_tag: "stop_to_upgrade"
    pods_tasks: true
    partial_pods: true
    nodes: ["wp_efk_app_wp"]
  wp_efk_app_efk_upgrade: 
    task_tag: "upgrade"
    pods_tasks: true
    partial_pods: true
    nodes: ["wp_efk_app_efk"]
  wp_efk_app_wp_upgrade:
    task_tag: "upgrade"
    pods_tasks: true
    partial_pods: true
    nodes: ["wp_efk_app_wp"]
  wp_web_stop:
    task_tag: "stop_to_upgrade"
    pods_tasks: true
    nodes: ["wp_web"]
  wp_db_upgrade:
    task_tag: "upgrade"
    pods_tasks: true
    nodes: ["wp_db"]
  wp_web_upgrade:
    task_tag: "upgrade"
    pods_tasks: true
    nodes: ["wp_web"]
run_stage_node_pods:
  wp_efk_app_efk: 
    node: "wp_efk_app"
    pods: 
    - >-
      {{ 
      params.env_params.dynamic | default(false) | bool | 
      ternary('efk_dynamic', 'efk')
      }}
  wp_efk_app_wp: 
    node: "wp_efk_app"
    pods:
    - >- 
      {{ 
      params.env_params.dynamic | default(false) | bool | 
      ternary('wp_app_dynamic', 'wp_app')
      }}
tasks_groups:
  node_prepare:
    prepare: "docker_compose_install"
  pod_bind:
    build: "main_build"
    upgrade: "main_upgrade"
    stop_to_upgrade: "skip"
    backup: "skip"
    wait: "main_wait"
  pod_efk:
    build: "main_build"
    upgrade: "main_upgrade"
    stop_to_upgrade: "skip"
    backup: "skip"
    wait: "main_wait"
  pod_discourse:
    build: "discourse_setup"
    upgrade: "discourse_rebuild"
    restore: "discourse_restore"
    stop_to_upgrade: "discourse_stop"
    upgrade_tools: "discourse_upgrade_tools"
    backup: "skip"
    wait: "skip"
    wait_db: "discourse_wait_db"
  pod_wp:
    build: "main_build"
    upgrade: "main_upgrade"
    stop_to_upgrade: "main_stop_to_upgrade"
    backup: "main_backup"
    wait: "main_wait"
    clear_all: "main_clear_all"
tasks:
  skip:
    type: "skip"
  discourse_setup:
    type: "shell"
    root: "true"
    cmd: "./custom-pod/discourse/scripts/setup.sh"
  discourse_rebuild:
    type: "shell"
    root: "true"
    cmd: "./repo-discourse/launcher rebuild app"
  discourse_rebuild_db:
    type: "shell"
    root: "true"
    cmd: "./repo-discourse/launcher rebuild db"
  discourse_rebuild_redis:
    type: "shell"
    root: "true"
    cmd: "./repo-discourse/launcher rebuild redis"
  discourse_rebuild_web:
    type: "shell"
    root: "true"
    cmd: "./repo-discourse/launcher rebuild web"
  discourse_bootstrap_web:
    type: "shell"
    root: "true"
    cmd: "./run discourse:bootstrap:web"
  discourse_restore:
    type: "shell"
    root: "true"
    cmd: "./run restore"
  discourse_stop:
    type: "shell"
    root: "true"
    cmd: "./repo-discourse/launcher stop app"
  discourse_upgrade_tools:
    type: "shell"
    root: "true"
    cmd: "./run upgrade"
  discourse_wait_db:
    type: "shell"
    root: "true"
    cmd: "./run verify"
  docker_compose_install:
    type: "task"
    root: "true"
    file: "docker.yml"
    compose_params:
      version: "1.25.3"
      remote: true
  main_build: 
    type: "shell"
    root: "true"
    cmd: "./run build"
  main_upgrade:
    type: "shell"
    root: "true"
    cmd: "./run upgrade"
  main_stop_to_upgrade:
    type: "shell"
    root: "true"
    cmd: "./run stop-to-upgrade"
  main_stop:
    type: "shell"
    root: "true"
    cmd: "./run stop"
  main_backup:
    type: "shell"
    root: "true"
    cmd: "./run backup"
  main_wait:
    type: "shell"
    root: "true"
    cmd: "sleep {{ params.env_params.wait | default('60') }}"
  main_clear_all:
    type: "shell"
    root: "true"
    cmd: "./run clear-all"
repos:
  cloud:
    src: "https://github.com/lucasbasquerotto/cloud.git"
    version: "master"
  custom_cloud:
    src: "https://github.com/lucasbasquerotto/custom-cloud.git"
    version: "master"
  pod:
    src: "https://github.com/lucasbasquerotto/pod.git"
    version: "master"
  custom_pod:
    src: "https://github.com/lucasbasquerotto/custom-pod.git"
    version: "master"
  discourse_docker:
    src: "https://github.com/discourse/discourse_docker.git"
    version: "master"
  discourse_docker_static:
    src: "https://github.com/lucasbasquerotto/discourse_docker.git"
    version: "2020-05-16"
  app:
    src: "https://github.com/lucasbasquerotto/wordpress-docker.git"
    version: "master"
credentials: "{{ params.credentials | default({}) }}"
