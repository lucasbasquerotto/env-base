name: "{{ params.name }}"
main: 
  local:
    clouds:
    - "local"
    nodes:
    - "mediawiki_local"
    local:
      pods: 
      - "mediawiki"
    params:
      entrypoint: "main.yml"
      entrypoint_template_src: "main.tpl.yml"
      hosts_content: |
        [main]
        localhost ansible_connection=local
        [host]
      meta:
        template_no_empty_lines: true
      repo: "cloud"
  remote: 
    destroy: 
      nodes: true
      buckets: true
    clouds:
    - "{{ params.env_params.cloud_name }}"
    buckets:
    - "mediawiki_backup"
    nodes:
    - "mediawiki"
    run_stages:
    - tasks:
      - name: "docker_compose_install"
        all_nodes: true
        nodes_tasks: true
      - name: "main_build"
        all_nodes: true
        pods_tasks: true
      - name: "main_upgrade"
        all_nodes: true
        pods_tasks: true
    params:
      entrypoint: "main.yml"
      entrypoint_template_src: "main.tpl.yml"
      repo: "cloud"
      hosts_content: |
        [main]
        localhost ansible_connection=local
        [host:children]
        mediawiki        
        [mediawiki]
clouds:
  local:
    type: "local"
  digital_ocean:
    type: "digital_ocean"
    credentials: "digital_ocean"
    params:
      x_digital_ocean_tags:
      - "auto"
      - "dmz"
      x_digital_ocean_firewalls:
      - name: "auto"
        tags: ["auto"]
        inbound_rules:
        - ports: "22"
          sources:
            tags: ["main"]
        outbound_rules:
        - protocol: "tcp"
          ports: "1-65535"
          destinations:
            addresses: ["0.0.0.0/0", "::/0"]
        - protocol: "udp"
          ports: "1-65535"
          destinations:
            addresses: ["0.0.0.0/0", "::/0"]
        - protocol: "icmp"
          ports: "1-65535"
          destinations:
            addresses: ["0.0.0.0/0", "::/0"]
      - name: "dmz"
        tags: ["dmz"]
        inbound_rules:
        - ports: "80"
          sources:
            addresses: ["0.0.0.0/0", "::/0"]
        - ports: "443"
          sources:
            addresses: ["0.0.0.0/0", "::/0"]
dns:
  cloudflare: 
    type: "cloudflare"
    zone: "{{ params.env_params.domain }}"
    credentials: "cloudflare"
  godaddy: 
    type: "godaddy"
    zone: "{{ params.env_params.domain }}"
    credentials: "godaddy"
buckets: 
  mediawiki_backup:
    name: "{{ params.env_params.mediawiki_backup_bucket_name }}"
    endpoint: "{{ params.env_params.mediawiki_backup_bucket_endpoint }}"
    credentials: "mediawiki_backup_bucket"
nodes:
  mediawiki_local:
    cloud: "local"
    base_dir: "/var/cloud"
    credentials: "user"
    pods: 
    - name: "mediawiki"
      params:
        local: true
      group_params:
        custom_args: "mediawiki_custom_args_local"
        custom_domain: "mediawiki_custom_domain_local"
        run: "mediawiki_custom_run_app_local"
    params:
      size:
        memory: "2gb"
        cpu: 2
  mediawiki:
    cloud: "{{ params.env_params.cloud_name }}"
    base_dir: "/var/cloud"
    credentials: "host"
    pods:
    - name: "mediawiki"
      params:
        local: false
      group_params:
        custom_args: "mediawiki_custom_args"
        custom_domain: "mediawiki_custom_domain"
        run: "mediawiki_custom_run_app"
    params:
      dns:
      - record: "{{ params.env_params.dns_record }}"
        name: "{{ params.env_params.dns_name }}"   
      cron:
      - user: "root"
        src_file: "{{ params.env.repo_dir }}/cron/app.cron"
        dest_dir: "/var/spool/cron/crontabs"     
      instance:
        image: "ubuntu-18-04-x64"
        user_data_file: "{{ params.env.repo_dir }}/templates/ubuntu-18.04.j2.sh"
        ipv6: "yes"
      region:
        name: "nyc3"
        region: "nyc"
        zone: "3"
      size:
        name: "s-1vcpu-1gb"
        memory: "1gb"
        cpu: 1
      host_test:
        log_file: "/var/log/setup.log"
        setup_last_line: "Setup Finished"
        initial_connection_timeout: 90
        setup_finished_timeout: 300
      x_digital_ocean_tags:
      - "auto"
      - "dmz"
pods:
  mediawiki:
    repo: "pod"
    root: "yes"
    ctx: "custom-pod/mediawiki/ctx.yml"
    fast_prepare: "true"
    env_repos: 
    - repo: "custom_pod"
      dir: "custom-pod"
    credentials:
      mediawiki: "mediawiki"
      mediawiki_backup_bucket: "mediawiki_backup_bucket"
    params:
      type: "app"
      orchestration: "docker_compose"
      custom_dir: "custom-pod"
      mediawiki: "{{ params.env_params.mediawiki }}"
    group_params:
      custom_images: "mediawiki_custom_images"
      custom_memory: "mediawiki_custom_memory_app"
      meta: "mediawiki_meta"
      run_dict: "mediawiki_run_dict"
pod_params:
  mediawiki_custom_args:
    nginx:
      http_port: "80"
      https_port: "443"
    mysql:
      host: "mysql"
      port: "3306"
    fluentd: 
      port: "24224"
  mediawiki_custom_args_local:
    nginx:
      http_port: "8080"
      https_port: "8443"
    mysql:
      host: "mysql"
      port: "3306"
  mediawiki_custom_domain:
    ssl: "{{ params.env_params.ssl }}"
    main_domain: "{{ params.env_params.mediawiki_full_domain }}"
    main_port: "{{ params.env_params.ssl | bool | ternary(443, 80) }}"
  mediawiki_custom_domain_local:
    ssl: "{{ params.env_params.ssl }}"
    main_domain: "localhost"
    main_port: "{{ params.env_params.ssl | bool | ternary(8443, 8080) }}"
  mediawiki_custom_images:
    nginx_image: "nginx"
    nginx_version: "1.14.2-alpine"
    mediawiki_image: "mediawiki"
    mediawiki_version: "1.34.1"
    mysql_image: "mariadb"
    mysql_version: "10.5.3-bionic"
    toolbox_image: "lucasbasquerotto/image"
    toolbox_version: "toolbox-20200513"
    awscli_image: "lucasbasquerotto/aws-cli"
    awscli_version: "1.0.0"
    fluentd_image: "lucasbasquerotto/wordpress"
    fluentd_version: "fluentd-1.7.4-01"
  mediawiki_custom_memory_app:
    nginx: 512mb
    mediawiki: 1gb
    mysql: 1gb
    toolbox: 512mb
    s3_backup: 512mb
    fluentd: 256mb
  mediawiki_custom_run_app:
    tasks: "tasks_app"
    general: "general"
    s3_logs: "s3_logs"
    setup_task_logs: "setup_task_logs"
    setup_verify_logs: "setup_verify_logs"
    setup_remote_logs: "setup_remote_logs"
    backup_task_logs: "backup_task_logs"
    backup_remote_logs: "backup_remote_logs"
  mediawiki_custom_run_app_local:
    tasks: "tasks_local"
    general: "general"
    s3_logs: "s3_logs"
    backup_task_logs: "backup_task_logs"
    backup_remote_logs: "backup_remote_logs"
  mediawiki_meta:
    use_run_dict: true
  mediawiki_run_dict:
    tasks_app:
      backup: "backup:task:logs" 
      setup: "setup:main:network,setup:task:logs" 
    tasks_local:
      backup: "backup:task:logs" 
      setup: "setup:main:network" 
    general:
      backup_delete_old_days: 3
      backup_local_base_dir: "/tmp/main/backup"
      orchestration: "compose"
      script_dir: "custom-pod/mediawiki"
      script_env_file: "main.sh"
      toolbox_service: "toolbox"
    s3_logs:
      endpoint: "{{ params.env_params.mediawiki_backup_bucket_endpoint }}"
      bucket_name: "{{ params.env_params.mediawiki_backup_bucket_name }}"
      service: "s3_backup"
      cli: "awscli"
      cli_cmd: "run"
    setup_task_logs:
      task_name_verify: "setup:verify:default:logs"
      task_name_remote: "setup:remote:default:logs"
      setup_dest_base_dir: "/var/log/main"
    setup_verify_logs:
      setup_dest_dir_to_verify: "/var/log/main"
    setup_remote_logs:
      task_kind: "dir"
      task_name_s3: "s3:task:logs"
      restore_tmp_dir: "/tmp/main/restore/log"
      restore_recursive_mode_dir: "777"
      restore_recursive_mode_file: "666"
      restore_remote_bucket_path_dir: "logs"
    backup_task_logs:
      task_name_remote: "backup:remote:default:logs"
      backup_src_base_dir: "/var/log"
      backup_local_static_dir:  "/tmp/main/backup/static"
    backup_remote_logs:
      task_kind: "dir"
      task_name_s3: "s3:task:logs"
      backup_src_dir: "main"
      backup_bucket_sync: "true"
      backup_bucket_sync_dir: "log"
tasks:
  docker_compose_install:
    type: "task"
    root: true
    file: "docker.yml"
    compose_params:
      version: "1.25.3"
      remote: true
  main_build: 
    type: "shell"
    root: true
    cmd: "./run build"
  main_upgrade:
    type: "shell"
    root: true
    cmd: "./run upgrade"
repos:
  cloud:
    src: "https://github.com/lucasbasquerotto/ansible-docker.git"
    version: "master"
  pod:
    src: "https://github.com/lucasbasquerotto/pod.git"
    version: "master"
  custom_pod:
    src: "https://github.com/lucasbasquerotto/custom-pod.git"
    version: "master"
credentials: "{{ params.credentials }}"
