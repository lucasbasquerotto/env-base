name: "{{ params.name }}"
ctxs: "{{ params.ctxs }}"
init:
  remote:
    entrypoint: "main.yml"
    entrypoint_template_src: "main.tpl.yml"
    repo: "cloud"
    hosts_content: |
      [main]
      localhost ansible_connection=local

      [host:children]
      remote
      
      [remote]
  local:
    entrypoint: "main.yml"
    entrypoint_template_src: "main.tpl.yml"
    repo: "cloud"
    hosts_content: |
      [main]
      localhost ansible_connection=local
      [host]
  external:
    repo: "cloud"
    hosts_file: "files/main/external.hosts"
main: 
  remote: 
    clouds:
    - "{{ params.env_params.cloud_name }}"
    dns: []
    nodes:
    - "remote"
    run_stages: 
    - "default"
  external:
    clouds:
    - "{{ params.env_params.cloud_name }}"
    nodes:
    - "external"
  local:
    clouds:
    - "local"
    nodes:
    - "local"
    local:
      pods:
      - "local"
clouds:
  digital_ocean:
    type: "digital_ocean"
    credentials: "digital_ocean"
    params:
      tags:
      - "main"
      firewalls:
      - "main"
    other_params:
      firewalls_dict: "do_firewalls_dict"
  local:
    type: "local"
cloud_params:   
  do_firewalls_dict:
    main:
      name: "main"
      tags: ["main"]
      inbound_rules:
      - ports: "22"
        sources:
          addresses: ["0.0.0.0/0", "::/0"]
      outbound_rules:
      - protocol: "tcp"
        ports: "1-65535"
        destinations:
          addresses: ["0.0.0.0/0", "::/0"]
      - protocol: "udp"
        ports: "1-65535"
        destinations:
          addresses: ["0.0.0.0/0", "::/0"]
      - protocol: "icmp"
        ports: "1-65535"
        destinations:
          addresses: ["0.0.0.0/0", "::/0"]
nodes:
  remote:
    amount: 1
    cloud: "{{ params.env_params.cloud_name }}"
    base_dir: "/var/cloud"
    credentials: "node"
    main_pod: "remote"
    tasks_group: "node_prepare"
    dependencies:
    - host: "main-domain-test"
      node: "remote"
    - host: "main-domain-test-new"
      node: "remote"
    params:
      instance: "ubuntu"
      region: "default"
      size: "micro"
      host_test_type: "default"
      cron: ["main"]
      digital_ocean_tags: ["main"]
    shared_params: "main"
  external:
    external: true
    cloud: "{{ params.env_params.cloud_name }}"
    base_dir: "/var/cloud"
    credentials: "node"
    main_pod: "remote"
    tasks_group: "node_prepare"
    params:
      instance: "ubuntu"
      region: "default"
      size: "micro"
      host_test_type: "default"
      cron: ["main"]
      digital_ocean_tags: ["main"]
    shared_params: "main"
  local:
    cloud: "local"
    base_dir: "/var/cloud"
    credentials: "node"
    main_pod: "local"
    tasks_group: "node_prepare"
    params: 
      size: "{{ params.env_params.node_size | default('micro') }}"
      cron: ["main"]
    shared_params: "main"
node_shared_params:
  main:
    cloud_instance_dict: "main_cloud_instance_dict"
    cloud_region_dict: "main_cloud_region_dict"
    cloud_size_dict: "main_cloud_size_dict"
    host_test_dict: "main_host_test_dict"
    cron_dict: "main_cron_dict"
node_params:
  main_cloud_instance_dict:
    digital_ocean:
      ubuntu:
        image: "ubuntu-18-04-x64"
        user_data_file: "{{ params.env.repo_dir }}/templates/ubuntu-18.04.j2.sh"
        ipv6: "yes"
  main_cloud_region_dict:
    digital_ocean:
      default:
        name: "nyc3"
        region: "nyc"
        zone: "3"
  main_cloud_size_dict:
    local:
      micro:
        memory: "1gb"
        cpu: 1
      small:
        memory: "2gb"
        cpu: 2
      medium:
        memory: "4gb"
        cpu: 4
      large:
        memory: "8gb"
        cpu: 8
      xlarge:
        memory: "16gb"
        cpu: 16
      x2large:
        memory: "32gb"
        cpu: 32
      x4large:
        memory: "64gb"
        cpu: 64
    digital_ocean:
      micro:
        name: "s-1vcpu-1gb"
        memory: "1gb"
        cpu: 1
      small:
        name: "s-2vcpu-2gb"
        memory: "2gb"
        cpu: 2
      medium:
        name: "s-2vcpu-4gb"
        memory: "4gb"
        cpu: 2
  main_host_test_dict:
    default:
      log_file: "/var/log/setup.log"
      setup_last_line: "Setup Finished"
      initial_connection_timeout: 90
      setup_finished_timeout: 300
  main_cron_dict: 
    main:
      user: "root"
      src_file: "{{ params.env.repo_dir }}/cron/main.cron"
      dest_dir: "/var/spool/cron/crontabs"
pods:
  remote:
    repo: "main"
    root: "yes"
    ctx: "ctx.yml"
    fast_prepare: "true"
    tasks_group: "pod_main"
    env_repos:
    - repo: "main_env"
      dir: "env-main"
    credentials:
      vault: "vault"
    params: 
      test: true
  local:
    repo: "main"
    root: "yes"
    ctx: "ctx.yml"
    fast_prepare: "true"
    env_repos:
    - repo: "main_env"
      dir: "env-main"
    credentials:
      vault: "vault"
    params: {}
repos:
  cloud:
    src: "https://github.com/lucasbasquerotto/ansible-docker.git"
    version: "master"
  main:
    src: "https://github.com/lucasbasquerotto/ansible-manager"
    version: "master"
  main_env:
    src: "ssh://git@bitbucket.org/lucasbasquerotto/ansible-main-env-demo.git"
    version: "master"
    private: true
    key_file_encrypted: "ssh/env_main.encrypted.key"
run_stages:
  default: ["default_prepare_nodes", "default_build_pods", "default_wait"]
run_stage_tasks:
  default_prepare_nodes:
    task_tag: "prepare"
    nodes_tasks: true
    all_nodes: true
  default_build_pods:
    task_tag: "build"
    pods_tasks: true
    all_nodes: true
  default_wait:
    task_tag: "wait"
    nodes_tasks: true
    all_nodes: true
tasks_groups:
  node_prepare:
    prepare: "docker_compose_install"
    wait: "main_wait"
  pod_main:
    build: "main_build"
tasks:
  skip:
    type: "skip"
  docker_compose_install:
    type: "task"
    root: "true"
    file: "docker.yml"
    compose_params:
      version: "1.25.3"
      remote: true
  main_build: 
    type: "task"
    root: "true"
    file: "docker-compose.build.yml"
  main_wait:
    type: "shell"
    root: "true"
    cmd: "sleep {{ params.env_params.wait | default('60') }}"
destroy:
  remote: 
    clouds:
    - "{{ params.env_params.cloud_name }}"
    dns: []
    nodes:
    - "remote"
    node_dns: true
  local: {}
credentials:
  node: "{{ params.credentials.node | default({}) }}"
  vault: "{{ params.credentials.vault | default({}) }}"
  digital_ocean: "{{ params.credentials.digital_ocean | default({}) }}"
