name: "{{ params.name }}"
ctxs: "{{ params.ctxs }}"
meta:
  template_no_empty_lines: true
main:
  local:
    repo: "cloud"
    env_repos:
      - repo: "custom_cloud"
        dir: "custom-cloud"
    hosts: |
      [main]
      localhost ansible_connection=local
      [host]
    nodes:
      - name: "ctl"
        key: "local"
        local: true
  remote:
    repo: "cloud"
    env_repos:
      - repo: "custom_cloud"
        dir: "custom-cloud"
    hosts: |
      [main]
      localhost ansible_connection=local
      [host:children]
      ctl
      [ctl]
    initial_services:
      - "{{ params.env_params.vpn_service | default('') }}"
    nodes:
      - name: "ctl"
        key: "remote"
        can_destroy: true
  external:
    repo: "cloud"
    env_repos:
      - repo: "custom_cloud"
        dir: "custom-cloud"
    hosts:
      type: "template"
      file: "files/hosts.tpl.ini"
      schema: "files/hosts.schema.yml"
      params:
        hosts:
          ctl:
            - name: "ctl-external-host"
              ip: "{{ params.env_params.external_ip | default('') }}"
              ipv4: "{{ params.env_params.external_ipv4 | default('') }}"
              ipv6: "{{ params.env_params.external_ipv6 | default('') }}"
              private_ip: "{{ params.env_params.external_private_ip | default('') }}"
            - name: "test-external-host"
              ip: "1.1.1.1"
              ipv4: "2.2.2.2"
              ipv6: "::2"
              private_ip: "3.3.3.3"
    initial_services:
      - "{{ params.env_params.vpn_service | default('') }}"
    nodes:
      - name: "ctl"
        key: "remote"
        external: true
services:
  digital_ocean_vpn:
    base_dir: "custom-cloud"
    namespace: "ext_vpn"
    task: "tasks/vpn/digital_ocean.main.vpn.yml"
    schema: "tasks/vpn/digital_ocean.schema.vpn.yml"
    credentials:
      vpn: "digital_ocean"
    params:
      tags:
        - "main"
      firewalls:
        - name: "main"
          tags: ["main"]
          inbound_rules:
            - ports: "22"
              sources:
                addresses: "{{ params.env_params.private_ips | default([]) }}"
          outbound_rules:
            - protocol: "tcp"
              ports: "1-65535"
              destinations:
                addresses: ["0.0.0.0/0", "::/0"]
            - protocol: "udp"
              ports: "1-65535"
              destinations:
                addresses: ["0.0.0.0/0", "::/0"]
            - protocol: "icmp"
              ports: "1-65535"
              destinations:
                addresses: ["0.0.0.0/0", "::/0"]
  digital_ocean_node:
    base_dir: "custom-cloud"
    namespace: "ext_node"
    task: "tasks/node/digital_ocean.main.node.yml"
    schema: "tasks/node/digital_ocean.schema.node.yml"
    credentials:
      node: "digital_ocean"
    params:
      image_id: "ubuntu-18-04-x64"
      ipv6: true
      region_id: "ams3"
      size_id: "s-1vcpu-1gb"
      tags:
        - "main"
    contents:
      user_data:
        type: "template"
        origin: "cloud"
        file: "custom-cloud/files/user-data/ubuntu-18.04.tpl.sh"
        schema: "custom-cloud/files/user-data/ubuntu-18.04.schema.yml"
        params:
          install_docker: true
          install_podman: false
          install_packages: false
        credentials:
          node: "host"
        contents:
          host_ssh_public_keys: "{{ params.env_params.host_ssh_public_keys_content | default('') }}"
nodes:
  local:
    pods: ["main"]
  remote:
    service: "{{ params.env_params.node_service | default('') }}"
    base_dir: "/var/cloud"
    root: true
    credentials:
      host: "host"
    pods: ["main"]
    params:
      host_users:
        - name: "host"
          setup_log_file: "/var/log/setup.log"
          setup_finished_log_regex: "^Setup Finished.*$"
          setup_success_log_last_line: "Setup Finished - Success"
          initial_connection_timeout: 90
          setup_finished_timeout: 300
      cron:
        - dest: "/var/spool/cron/crontabs/root"
          user: "root"
          src:
            type: "template"
            origin: "cloud"
            file: "custom-cloud/files/cron/pod.tpl.sh"
            schema: "custom-cloud/files/cron/pod.schema.yml"
            params:
              tasks:
                - name: "sync"
                  task: "sync:verify"
                  cron: "*/1 * * * *"
pods:
  main:
    repo: "main"
    env_repos:
      - repo: "env_main"
        dir: "env-main"
    root: true
    fast_prepare: true
    pod_dir_relpath: "ctl"
repos:
  cloud:
    src: "https://github.com/lucasbasquerotto/cloud.git"
    version: "master"
  main:
    src: "https://github.com/lucasbasquerotto/ctl.git"
    version: "master"
  env_main:
    src: "ssh://git@bitbucket.org/lucasbasquerotto/ansible-main-env-demo.git"
    version: "master"
    ssh_file: "ssh/env_main.encrypted.key"
  custom_cloud:
    src: "https://github.com/lucasbasquerotto/custom-cloud.git"
    version: "master"
credentials:
  host: "{{ params.credentials.host | default({}) }}"
  digital_ocean: "{{ params.credentials.digital_ocean | default({}) }}"
